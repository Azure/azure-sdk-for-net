
# Table of Contents
1. [Generate Mock Test](#generate-mock-test)
2. [Prepare the Mock-service-host](#prepare-mock-service-host)
3. [Execute Mock Test](#execute-mock-test)
4. [How to skip failure test](#skip-swagger-example)

<div id="generate-mock-test"/>

# Generate Mock Test 
The 'GenerateTest' command will be supported in azure-sdk-for-net after test generation PR is merged, released and referred by azure-sdk-for-net.
The Mgmt tests can be generated by below steps:
1. 'cd' to Azure.ResourceManager.xxx\tests

2. Create Azure.ResourceManager.xxx.csproj file, and make sure it use the test helper project. Below is a test project template file:
~~~
<Project Sdk="Microsoft.NET.Sdk">
  <PropertyGroup>
    <TestHelperProjects>Rbac1.6;</TestHelperProjects>
  </PropertyGroup>
  <ItemGroup>
    <ProjectReference Include="..\src\Azure.ResourceManager.xxx.csproj" />
  </ItemGroup>
  <ItemGroup>
    <PackageReference Include="Azure.Identity" />
  </ItemGroup>
</Project>
~~~

3. Create file autorest.tests.md, the content are:
~~~
# Generated test code configuration

Run `dotnet build /t:GenerateTest` to generate test code.

``` yaml
require:
  - ../src/autorest.md
```
~~~

4. Generate

[BEFORE PR MERGED]
- clone test generation branch at https://github.com/changlong-liu/autorest.csharp/tree/20211009-rebase
- build autorest.csharp
- generate with command:
~~~
autorest --use=D:\projects\codegen\autorest.csharp\artifacts\bin\AutoRest.CSharp\Debug\netcoreapp3.1 D:\projects\codegen\azure-sdk-for-net\sdk\sqlmanagement\Azure.ResourceManager.Sql\tests\autorest.tests.md --testmodeler={} --debug
~~~


[AFTER PR MERGED]

Execute "dotnet build /t:GenerateTest". It will generate test files like below:
~~~
D:.
│   autorest.tests.md
│   Azure.ResourceManager.KeyVault.Tests.csproj
│
├───generated
│   │
│   └───Mock
│           DeletedManagedHsmCollectionTest.cs
│           DeletedManagedHsmTest.cs
│           DeletedVaultCollectionTest.cs
│           DeletedVaultTest.cs
│           ManagedHsmCollectionTest.cs
│           ManagedHsmTest.cs
│           MhsmPrivateEndpointConnectionCollectionTest.cs
│           MhsmPrivateEndpointConnectionTest.cs
│           PrivateEndpointConnectionCollectionTest.cs
│           PrivateEndpointConnectionTest.cs
│           TestHelper.cs
│           VaultCollectionTest.cs
│           VaultTest.cs
~~~


<div id="prepare-mock-service-host"/>

# Prepare the Mock-service-host
> **_NOTE:_** The mock-service-host use [OpenSSL Toolkit](https://www.openssl.org/) to create certificates for HTTPS channel. So make sure it's available in your computer.
## Install mock-service-host
1. Use git to clone this repo to your local workspace.

~~~ shell
# cd MY_WORKSPACE
# git clone git@github.com:Azure/azure-sdk-tools.git
# cd tools/mock-service-host
# npm install
~~~

2 Configure mock-service-host

The Azrue Rest Api Spec repo is a companion repo of mock-service-host. By default, the mock-service-host download [the public azure swagger repo](https://github.com/Azure/azure-rest-api-specs) to cache folder when it start. You can create file '.env' to ask it to use specific swagger commit.

~~~
+-- mock-service-host/
|   +-- cache/                   // swagger repos will be downloaded here in the first start-up of mock-service-host
|   +-- .env                     // you can create this file, and add configs in it.
~~~

Set target swagger files as bellow in .env:
~~~
specRetrievalGitUrl=https://github.com/Azure/azure-rest-api-specs
specRetrievalGitBranch=main
specRetrievalGitCommitID=xxx
validationPathsPattern=specification/*/resource-manager/*/**/*.json
~~~

And you can specify a narrow rule to enable only your own RP's json files to accelerate the loading speed of mock-service-host. For instance:
~~~
validationPathsPattern=specification/mediaservices/resource-manager/Microsoft.Media/**/*.json
~~~

If you want mock-service-host to use local swagger repo existed in your computer, the '.env' file can be like bellow:
~~~
specRetrievalMethod=filesystem
specRetrievalLocalRelativePath=../azure-rest-api-specs
validationPathsPattern=specification/*/resource-manager/*/**/*.json
~~~

## Launch
~~~ shell
# npm run start
~~~
If only one RP is confiured in 'validationPathsPattern', it takes seconds for mock-service-host to load it.
The mock-service-host is ready after 'validator initialized' is shown.
~~~
D:\projects\codegen\azure-sdk-tools\tools\mock-service-host>npm run start

> @azure-tools/mock-service-host@0.1.8 start D:\projects\codegen\azure-sdk-tools\tools\mock-service-host
> tsc && node dist/src/main.js

Listening https on port: 8441
Listening http on port: 8442
Listening https on port: 8443
Listening https on port: 8445
2021-12-21T07:54:10.265Z [info]: SpecRetrieverFilesystem: Set spec cache path as ../../../azure-rest-api-specs
2021-12-21T07:54:10.267Z [info]: validator is initializing with options {
    "git": {
        "url": "https://github.com/Azure/azure-rest-api-specs",
        "shouldClone": false
    },
    "swaggerPathsPattern": [
        "specification/keyvault/resource-manager/**/*.json"
    ],
    "directory": "D:\\projects\\codegen\\azure-rest-api-specs",
    "isPathCaseSensitive": false
}
2021-12-21T07:54:10.809Z [info]: validator initialized
~~~


<div id="execute-mock-test"/>

# Execute Mock Test
## Trust the mock-service-host certificate in computer
The mock-service-host use a self-signed certificate to enable HTTPs channel, so need to trust the certificate before execute any mock test.
Once the mock-service-host is launched, the certificate will be created as 'mock-service-host/.ssh/localhost-ca.crt'. Double click the crt file and follow below to install it.

![how-to-trust-certificate.png](images/trust-certificate.png)

## Execute
Now you can execute the generated mock test like any others.
All mock tests are generated in namespace 'Azure.ResourceManager.xxx.Tests.Mock', below is an picture for executing mock test in visual studio test explorer.

![test-explorer.png](images/test-explorer.png)

> **_NOTE:_** Recording files will be generated after the executing, need to include the recording files if want to commit the generated test into the sdk repo.


<div id="skip-swagger-example"/>

# How to Skip swagger Example
The test may be failed for tooling or example issues. You can skip the test generation for specific examples with configuration 'testmodeler.mock.disabled-examples' in autorest.tests.md
~~~
testmodeler:
  mock:
    disabled-examples:
      - Create a virtual machine image from a managed disk with DiskEncryptionSet resource.
      - Create a virtual machine image from a managed disk.
~~~
The example names can be copied from the generated test function:

![find-example-name.png](images/find-example-name.png)
