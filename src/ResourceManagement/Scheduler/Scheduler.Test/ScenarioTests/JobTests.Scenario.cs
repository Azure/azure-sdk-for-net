// 
// Copyright (c) Microsoft and contributors.  All rights reserved.
// 
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
// http://www.apache.org/licenses/LICENSE-2.0
// 
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// 
// See the License for the specific language governing permissions and
// limitations under the License.
// Code generated by Microsoft (R) AutoRest Code Generator {0}
// Changes may cause incorrect behavior and will be lost if the code is
// regenerated.
// 

using Microsoft.Azure.Management.Scheduler;
using Microsoft.Azure.Management.Scheduler.Models;
using Microsoft.Rest.ClientRuntime.Azure.TestFramework;
using Scheduler.Test.Helpers;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Net;
using Xunit;
using SchedulerDayOfWeek = Microsoft.Azure.Management.Scheduler.Models.DayOfWeek;

namespace Scheduler.Test.ScenarioTests
{
    public class JobTests
    {
        private const string subscriptionId = "6c55a6f0-6593-472f-9b3e-a51a9a757b40";
        private const string resourceGroupName = "CS-SouthCentralUS-scheduler";
        private const string type = "Microsoft.Scheduler/jobCollections/jobs";
        private const string location = "South Central US";
        private const string jobCollectionName = "jc1";

        [Fact]
        public void Scenario_JobCreateWithScheduleForDay()
        {
            using (MockContext context = MockContext.Start())
            {
                const string jobName = "j1";
                string jobDefinitionname = string.Format("{0}/{1}", jobCollectionName, jobName);
                string id = string.Format("/subscriptions/{0}/resourceGroups/{1}/providers/Microsoft.Scheduler/jobCollections/{2}/jobs/{3}", subscriptionId, resourceGroupName, jobCollectionName, jobName);

                var client = TestBase.GetServiceClient<SchedulerManagementClient>();
                this.CreateJobCollection(client);

                var result = client.Jobs.CreateOrUpdate(
                    resourceGroupName: resourceGroupName,
                    jobCollectionName: jobCollectionName,
                    jobName: jobName,
                    job: new JobDefinition()
                    {
                        Properties = new JobProperties()
                        {
                            StartTime = new DateTime(2015, 7, 13),
                            Action = new JobAction()
                            {
                                Type = JobActionType.Http,
                                Request = new HttpRequest()
                                {
                                    Uri = "http://www.bing.com/",
                                    Method = "GET",
                                },
                                RetryPolicy = new RetryPolicy()
                                {
                                    RetryType = RetryType.None,
                                },
                                ErrorAction = new JobErrorAction()
                                {
                                    Type = JobActionType.StorageQueue,
                                    QueueMessage = new StorageQueueMessage()
                                    {
                                        StorageAccount = "schedulersdktest",
                                        QueueName = "queue1",
                                        Message = "some message!",
                                        SasToken = "lMyYwRg47zzabQvrL1fl0VtFfFCYi7YV80zAbrqT6H9iyj7N4duNHN0Cf7HecpResRCFtZhoCRrFwTIOwJKLhw==",
                                    }
                                }
                            },
                            Recurrence = new JobRecurrence()
                            {
                                Frequency = RecurrenceFrequency.Day,
                                Count = 100,
                                EndTime = new DateTime(2015, 10, 10, 10, 10, 10, DateTimeKind.Utc),
                                Schedule = new JobRecurrenceSchedule()
                                {
                                    Hours = new List<int?>() { 5, 10, 15, 20 },
                                    Minutes = new List<int?>() { 0, 10, 20, 30, 40, 50 },
                                }
                            },
                            State = JobState.Enabled,
                        }
                    });

                Assert.Equal(id, result.Id);
                Assert.Equal(type, result.Type);
                Assert.Equal(jobDefinitionname, result.Name);
                Assert.Equal(JobActionType.Http, result.Properties.Action.Type);
                Assert.Equal("http://www.bing.com/", result.Properties.Action.Request.Uri);
                Assert.Equal("GET", result.Properties.Action.Request.Method);
                Assert.Equal(RetryType.None, result.Properties.Action.RetryPolicy.RetryType);
                Assert.Equal(JobActionType.StorageQueue, result.Properties.Action.ErrorAction.Type);
                Assert.Equal("schedulersdktest", result.Properties.Action.ErrorAction.QueueMessage.StorageAccount);
                Assert.Equal("queue1", result.Properties.Action.ErrorAction.QueueMessage.QueueName);
                Assert.Equal("some message!", result.Properties.Action.ErrorAction.QueueMessage.Message);
                Assert.Equal("lMyYwRg47zzabQvrL1fl0VtFfFCYi7YV80zAbrqT6H9iyj7N4duNHN0Cf7HecpResRCFtZhoCRrFwTIOwJKLhw==", result.Properties.Action.ErrorAction.QueueMessage.SasToken);
                Assert.Equal(JobState.Enabled, result.Properties.State);
                Assert.Equal(RecurrenceFrequency.Day, result.Properties.Recurrence.Frequency);
                Assert.Equal(100, result.Properties.Recurrence.Count);
                Assert.Equal(new DateTime(2015, 10, 10, 10, 10, 10, DateTimeKind.Utc), result.Properties.Recurrence.EndTime);
                Assert.Equal(new List<int?>() { 5, 10, 15, 20 }, result.Properties.Recurrence.Schedule.Hours);
                Assert.Equal(new List<int?>() { 0, 10, 20, 30, 40, 50 }, result.Properties.Recurrence.Schedule.Minutes);
                Assert.Null(result.Properties.Status.LastExecutionTime);
                Assert.Equal(0, result.Properties.Status.ExecutionCount);
                Assert.Equal(0, result.Properties.Status.FailureCount);
                Assert.Equal(0, result.Properties.Status.FaultedCount);

                var getResult = client.Jobs.Get(resourceGroupName, jobCollectionName, jobName);

                Assert.Equal(id, getResult.Id);
                Assert.Equal(type, getResult.Type);
                Assert.Equal(jobDefinitionname, getResult.Name);
                Assert.Equal(JobActionType.Http, getResult.Properties.Action.Type);
                Assert.Equal("http://www.bing.com/", getResult.Properties.Action.Request.Uri);
                Assert.Equal("GET", getResult.Properties.Action.Request.Method);
                Assert.Equal(RetryType.None, getResult.Properties.Action.RetryPolicy.RetryType);
                Assert.Equal(JobActionType.StorageQueue, getResult.Properties.Action.ErrorAction.Type);
                Assert.Equal("schedulersdktest", getResult.Properties.Action.ErrorAction.QueueMessage.StorageAccount);
                Assert.Equal("queue1", getResult.Properties.Action.ErrorAction.QueueMessage.QueueName);
                Assert.Equal("some message!", getResult.Properties.Action.ErrorAction.QueueMessage.Message);
                Assert.Equal("lMyYwRg47zzabQvrL1fl0VtFfFCYi7YV80zAbrqT6H9iyj7N4duNHN0Cf7HecpResRCFtZhoCRrFwTIOwJKLhw==", getResult.Properties.Action.ErrorAction.QueueMessage.SasToken);
                Assert.Equal(JobState.Enabled, getResult.Properties.State);
                Assert.Equal(RecurrenceFrequency.Day, getResult.Properties.Recurrence.Frequency);
                Assert.Equal(100, getResult.Properties.Recurrence.Count);
                Assert.Equal(new DateTime(2015, 10, 10, 10, 10, 10, DateTimeKind.Utc), getResult.Properties.Recurrence.EndTime);
                Assert.Equal(new List<int?>() { 5, 10, 15, 20 }, getResult.Properties.Recurrence.Schedule.Hours);
                Assert.Equal(new List<int?>() { 0, 10, 20, 30, 40, 50 }, getResult.Properties.Recurrence.Schedule.Minutes);
                Assert.Null(getResult.Properties.Status.LastExecutionTime);
                Assert.Equal(0, getResult.Properties.Status.ExecutionCount);
                Assert.Equal(0, getResult.Properties.Status.FailureCount);
                Assert.Equal(0, getResult.Properties.Status.FaultedCount);

                client.JobCollections.Delete(resourceGroupName, jobCollectionName);
            }
        }

        [Fact]
        public void Scenario_JobCreateWithScheduleForWeek()
        {
            using (MockContext context = MockContext.Start())
            {
                const string jobName = "j1";
                string jobDefinitionname = string.Format("{0}/{1}", jobCollectionName, jobName);
                string id = string.Format("/subscriptions/{0}/resourceGroups/{1}/providers/Microsoft.Scheduler/jobCollections/{2}/jobs/{3}", subscriptionId, resourceGroupName, jobCollectionName, jobName);

                var client = TestBase.GetServiceClient<SchedulerManagementClient>();
                this.CreateJobCollection(client);

                var result = client.Jobs.CreateOrUpdate(
                    resourceGroupName: resourceGroupName,
                    jobCollectionName: jobCollectionName,
                    jobName: jobName,
                    job: new JobDefinition()
                    {
                        Properties = new JobProperties()
                        {
                            StartTime = new DateTime(2015, 7, 13),
                            Action = new JobAction()
                            {
                                Type = JobActionType.StorageQueue,
                                QueueMessage = new StorageQueueMessage()
                                {
                                    StorageAccount = "schedulersdktest",
                                    QueueName = "queue1",
                                    Message = "some message!",
                                    SasToken = "lMyYwRg47zzabQvrL1fl0VtFfFCYi7YV80zAbrqT6H9iyj7N4duNHN0Cf7HecpResRCFtZhoCRrFwTIOwJKLhw==",
                                },
                                RetryPolicy = new RetryPolicy()
                                {
                                    RetryType = RetryType.Fixed,
                                    RetryCount = 2,
                                    RetryInterval = TimeSpan.FromMinutes(1),
                                },
                            },
                            Recurrence = new JobRecurrence()
                            {
                                Frequency = RecurrenceFrequency.Week,
                                Interval = 1,
                                Count = 10000,
                                EndTime = new DateTime(2015, 10, 10, 10, 10, 10, DateTimeKind.Utc),
                                Schedule = new JobRecurrenceSchedule()
                                {
                                    WeekDays = new List<SchedulerDayOfWeek?>() { SchedulerDayOfWeek.Monday },
                                    Hours = new List<int?>() { 5, 10, 15, 20 },
                                    Minutes = new List<int?>() { 0, 10, 20, 30, 40, 50 },
                                }
                            },
                            State = JobState.Enabled,
                        }
                    });

                Assert.Equal(id, result.Id);
                Assert.Equal(type, result.Type);
                Assert.Equal(jobDefinitionname, result.Name);
                Assert.Equal(JobActionType.StorageQueue, result.Properties.Action.Type);
                Assert.Equal("schedulersdktest", result.Properties.Action.QueueMessage.StorageAccount);
                Assert.Equal("queue1", result.Properties.Action.QueueMessage.QueueName);
                Assert.Equal("some message!", result.Properties.Action.QueueMessage.Message);
                Assert.Null(result.Properties.Action.QueueMessage.SasToken);
                Assert.Equal(RetryType.Fixed, result.Properties.Action.RetryPolicy.RetryType);
                Assert.Equal(2, result.Properties.Action.RetryPolicy.RetryCount);
                Assert.Equal(TimeSpan.FromMinutes(1), result.Properties.Action.RetryPolicy.RetryInterval);
                Assert.Equal(JobState.Enabled, result.Properties.State);
                Assert.Equal(RecurrenceFrequency.Week, result.Properties.Recurrence.Frequency);
                Assert.Equal(1, result.Properties.Recurrence.Interval);
                Assert.Equal(10000, result.Properties.Recurrence.Count);
                Assert.Equal(new DateTime(2015, 10, 10, 10, 10, 10, DateTimeKind.Utc), result.Properties.Recurrence.EndTime);
                Assert.Equal(new List<SchedulerDayOfWeek?>() { SchedulerDayOfWeek.Monday }, result.Properties.Recurrence.Schedule.WeekDays);
                Assert.Equal(new List<int?>() { 5, 10, 15, 20 }, result.Properties.Recurrence.Schedule.Hours);
                Assert.Equal(new List<int?>() { 0, 10, 20, 30, 40, 50 }, result.Properties.Recurrence.Schedule.Minutes);
                Assert.Null(result.Properties.Status.LastExecutionTime);
                Assert.Equal(0, result.Properties.Status.ExecutionCount);
                Assert.Equal(0, result.Properties.Status.FailureCount);
                Assert.Equal(0, result.Properties.Status.FaultedCount);

                var getResult = client.Jobs.Get(resourceGroupName, jobCollectionName, jobName);

                Assert.Equal(type, getResult.Type);
                Assert.Equal(jobDefinitionname, getResult.Name);
                Assert.Equal(JobActionType.StorageQueue, getResult.Properties.Action.Type);
                Assert.Equal("schedulersdktest", getResult.Properties.Action.QueueMessage.StorageAccount);
                Assert.Equal("queue1", getResult.Properties.Action.QueueMessage.QueueName);
                Assert.Equal("some message!", getResult.Properties.Action.QueueMessage.Message);
                Assert.Null(getResult.Properties.Action.QueueMessage.SasToken);
                Assert.Equal(RetryType.Fixed, getResult.Properties.Action.RetryPolicy.RetryType);
                Assert.Equal(2, getResult.Properties.Action.RetryPolicy.RetryCount);
                Assert.Equal(TimeSpan.FromMinutes(1), getResult.Properties.Action.RetryPolicy.RetryInterval);
                Assert.Equal(JobState.Enabled, getResult.Properties.State);
                Assert.Equal(RecurrenceFrequency.Week, getResult.Properties.Recurrence.Frequency);
                Assert.Equal(1, getResult.Properties.Recurrence.Interval);
                Assert.Equal(10000, getResult.Properties.Recurrence.Count);
                Assert.Equal(new DateTime(2015, 10, 10, 10, 10, 10, DateTimeKind.Utc), getResult.Properties.Recurrence.EndTime);
                Assert.Equal(new List<SchedulerDayOfWeek?>() { SchedulerDayOfWeek.Monday }, getResult.Properties.Recurrence.Schedule.WeekDays);
                Assert.Equal(new List<int?>() { 5, 10, 15, 20 }, getResult.Properties.Recurrence.Schedule.Hours);
                Assert.Equal(new List<int?>() { 0, 10, 20, 30, 40, 50 }, getResult.Properties.Recurrence.Schedule.Minutes);
                Assert.Null(getResult.Properties.Status.LastExecutionTime);
                Assert.Equal(0, getResult.Properties.Status.ExecutionCount);
                Assert.Equal(0, getResult.Properties.Status.FailureCount);
                Assert.Equal(0, getResult.Properties.Status.FaultedCount);

                client.JobCollections.Delete(resourceGroupName, jobCollectionName);
            }
        }

        [Fact]
        public void Scenario_JobCreateWithScheduleForMonth()
        {
            using (MockContext context = MockContext.Start())
            {
                const string jobName = "j1";
                string jobDefinitionname = string.Format("{0}/{1}", jobCollectionName, jobName);
                string id = string.Format("/subscriptions/{0}/resourceGroups/{1}/providers/Microsoft.Scheduler/jobCollections/{2}/jobs/{3}", subscriptionId, resourceGroupName, jobCollectionName, jobName);

                var client = TestBase.GetServiceClient<SchedulerManagementClient>();
                this.CreateJobCollection(client);

                var result = client.Jobs.CreateOrUpdate(
                    resourceGroupName: resourceGroupName,
                    jobCollectionName: jobCollectionName,
                    jobName: jobName,
                    job: new JobDefinition()
                    {
                        Properties = new JobProperties()
                        {
                            StartTime = new DateTime(2015, 7, 13),
                            Action = new JobAction()
                            {
                                Type = JobActionType.StorageQueue,
                                QueueMessage = new StorageQueueMessage()
                                {
                                    StorageAccount = "schedulersdktest",
                                    QueueName = "queue1",
                                    Message = "some message!",
                                    SasToken = "lMyYwRg47zzabQvrL1fl0VtFfFCYi7YV80zAbrqT6H9iyj7N4duNHN0Cf7HecpResRCFtZhoCRrFwTIOwJKLhw==",
                                },
                                RetryPolicy = new RetryPolicy()
                                {
                                    RetryType = RetryType.Fixed,
                                    RetryCount = 2,
                                    RetryInterval = TimeSpan.FromMinutes(1),
                                },
                                ErrorAction = new JobErrorAction()
                                {
                                    Type = JobActionType.Http,
                                    Request = new HttpRequest()
                                    {
                                        Uri = "http://www.bing.com/",
                                        Method = "GET",
                                    },
                                }
                            },
                            Recurrence = new JobRecurrence()
                            {
                                Frequency = RecurrenceFrequency.Month,
                                Interval = 1,
                                Count = 10000,
                                EndTime = new DateTime(2015, 10, 10, 10, 10, 10, DateTimeKind.Utc),
                                Schedule = new JobRecurrenceSchedule()
                                {
                                    MonthDays = new List<int?>() { 15, 30 },
                                    Hours = new List<int?>() { 5, 10, 15, 20 },
                                    Minutes = new List<int?>() { 0, 10, 20, 30, 40, 50 },
                                }
                            },
                            State = JobState.Enabled,
                        }
                    });

                Assert.Equal(id, result.Id);
                Assert.Equal(type, result.Type);
                Assert.Equal(jobDefinitionname, result.Name);
                Assert.Equal(JobActionType.StorageQueue, result.Properties.Action.Type);
                Assert.Equal("schedulersdktest", result.Properties.Action.QueueMessage.StorageAccount);
                Assert.Equal("queue1", result.Properties.Action.QueueMessage.QueueName);
                Assert.Equal("some message!", result.Properties.Action.QueueMessage.Message);
                Assert.Null(result.Properties.Action.QueueMessage.SasToken);
                Assert.Equal(RetryType.Fixed, result.Properties.Action.RetryPolicy.RetryType);
                Assert.Equal(2, result.Properties.Action.RetryPolicy.RetryCount);
                Assert.Equal(TimeSpan.FromMinutes(1), result.Properties.Action.RetryPolicy.RetryInterval);
                Assert.Equal(JobActionType.Http, result.Properties.Action.ErrorAction.Type);
                Assert.Equal("http://www.bing.com/", result.Properties.Action.ErrorAction.Request.Uri);
                Assert.Equal("GET", result.Properties.Action.ErrorAction.Request.Method);
                Assert.Equal(JobState.Enabled, result.Properties.State);
                Assert.Equal(RecurrenceFrequency.Month, result.Properties.Recurrence.Frequency);
                Assert.Equal(1, result.Properties.Recurrence.Interval);
                Assert.Equal(10000, result.Properties.Recurrence.Count);
                Assert.Equal(new DateTime(2015, 10, 10, 10, 10, 10, DateTimeKind.Utc), result.Properties.Recurrence.EndTime);
                Assert.Equal(new List<int?>() { 15, 30 }, result.Properties.Recurrence.Schedule.MonthDays);
                Assert.Equal(new List<int?>() { 5, 10, 15, 20 }, result.Properties.Recurrence.Schedule.Hours);
                Assert.Equal(new List<int?>() { 0, 10, 20, 30, 40, 50 }, result.Properties.Recurrence.Schedule.Minutes);
                Assert.Null(result.Properties.Status.LastExecutionTime);
                Assert.Equal(0, result.Properties.Status.ExecutionCount);
                Assert.Equal(0, result.Properties.Status.FailureCount);
                Assert.Equal(0, result.Properties.Status.FaultedCount);

                var getResult = client.Jobs.Get(resourceGroupName, jobCollectionName, jobName);

                Assert.Equal(type, getResult.Type);
                Assert.Equal(jobDefinitionname, getResult.Name);
                Assert.Equal(JobActionType.StorageQueue, getResult.Properties.Action.Type);
                Assert.Equal("schedulersdktest", getResult.Properties.Action.QueueMessage.StorageAccount);
                Assert.Equal("queue1", getResult.Properties.Action.QueueMessage.QueueName);
                Assert.Equal("some message!", getResult.Properties.Action.QueueMessage.Message);
                Assert.Null(getResult.Properties.Action.QueueMessage.SasToken);
                Assert.Equal(RetryType.Fixed, getResult.Properties.Action.RetryPolicy.RetryType);
                Assert.Equal(2, getResult.Properties.Action.RetryPolicy.RetryCount);
                Assert.Equal(TimeSpan.FromMinutes(1), getResult.Properties.Action.RetryPolicy.RetryInterval);
                Assert.Equal(JobActionType.Http, getResult.Properties.Action.ErrorAction.Type);
                Assert.Equal("http://www.bing.com/", getResult.Properties.Action.ErrorAction.Request.Uri);
                Assert.Equal("GET", getResult.Properties.Action.ErrorAction.Request.Method);
                Assert.Equal(JobState.Enabled, getResult.Properties.State);
                Assert.Equal(RecurrenceFrequency.Month, getResult.Properties.Recurrence.Frequency);
                Assert.Equal(1, getResult.Properties.Recurrence.Interval);
                Assert.Equal(10000, getResult.Properties.Recurrence.Count);
                Assert.Equal(new DateTime(2015, 10, 10, 10, 10, 10, DateTimeKind.Utc), getResult.Properties.Recurrence.EndTime);
                Assert.Equal(new List<int?>() { 15, 30 }, getResult.Properties.Recurrence.Schedule.MonthDays);
                Assert.Equal(new List<int?>() { 5, 10, 15, 20 }, getResult.Properties.Recurrence.Schedule.Hours);
                Assert.Equal(new List<int?>() { 0, 10, 20, 30, 40, 50 }, getResult.Properties.Recurrence.Schedule.Minutes);
                Assert.Null(getResult.Properties.Status.LastExecutionTime);
                Assert.Equal(0, getResult.Properties.Status.ExecutionCount);
                Assert.Equal(0, getResult.Properties.Status.FailureCount);
                Assert.Equal(0, getResult.Properties.Status.FaultedCount);

                client.JobCollections.Delete(resourceGroupName, jobCollectionName);
            }
        }

        [Fact]
        public void Scenario_JobCreateWithScheduleForMonthlyOccurrence()
        {
            using (MockContext context = MockContext.Start())
            {
                const string jobName = "j1";
                string jobDefinitionname = string.Format("{0}/{1}", jobCollectionName, jobName);
                string id = string.Format("/subscriptions/{0}/resourceGroups/{1}/providers/Microsoft.Scheduler/jobCollections/{2}/jobs/{3}", subscriptionId, resourceGroupName, jobCollectionName, jobName);

                var client = TestBase.GetServiceClient<SchedulerManagementClient>();
                this.CreateJobCollection(client);

                var result = client.Jobs.CreateOrUpdate(
                    resourceGroupName: resourceGroupName,
                    jobCollectionName: jobCollectionName,
                    jobName: jobName,
                    job: new JobDefinition()
                    {
                        Properties = new JobProperties()
                        {
                            StartTime = new DateTime(2015, 7, 13),
                            Action = new JobAction()
                            {
                                Type = JobActionType.StorageQueue,
                                QueueMessage = new StorageQueueMessage()
                                {
                                    StorageAccount = "schedulersdktest",
                                    QueueName = "queue1",
                                    Message = "some message!",
                                    SasToken = "lMyYwRg47zzabQvrL1fl0VtFfFCYi7YV80zAbrqT6H9iyj7N4duNHN0Cf7HecpResRCFtZhoCRrFwTIOwJKLhw==",
                                },
                                RetryPolicy = new RetryPolicy()
                                {
                                    RetryType = RetryType.Fixed,
                                    RetryCount = 2,
                                    RetryInterval = TimeSpan.FromMinutes(1),
                                },
                                ErrorAction = new JobErrorAction()
                                {
                                    Type = JobActionType.Http,
                                    Request = new HttpRequest()
                                    {
                                        Uri = "http://www.bing.com/",
                                        Method = "GET",
                                    },
                                }
                            },
                            Recurrence = new JobRecurrence()
                            {
                                Frequency = RecurrenceFrequency.Month,
                                Interval = 1,
                                Count = 10000,
                                EndTime = new DateTime(2015, 10, 10, 10, 10, 10, DateTimeKind.Utc),
                                Schedule = new JobRecurrenceSchedule()
                                {
                                    Hours = new List<int?>() { 5, 10, 15, 20 },
                                    Minutes = new List<int?>() { 0, 10, 20, 30, 40, 50 },
                                    MonthlyOccurrences = new List<JobRecurrenceScheduleMonthlyOccurrence>() 
                                    { 
                                        new JobRecurrenceScheduleMonthlyOccurrence()
                                        {
                                            Day = JobScheduleDay.Monday,
                                            Occurrence = 1,
                                        },
                                        new JobRecurrenceScheduleMonthlyOccurrence()
                                        {
                                            Day = JobScheduleDay.Friday,
                                            Occurrence = 1,
                                        }
                                    },
                                }
                            },
                            State = JobState.Enabled,
                        }
                    });

                Assert.Equal(id, result.Id);
                Assert.Equal(type, result.Type);
                Assert.Equal(jobDefinitionname, result.Name);
                Assert.Equal(JobActionType.StorageQueue, result.Properties.Action.Type);
                Assert.Equal("schedulersdktest", result.Properties.Action.QueueMessage.StorageAccount);
                Assert.Equal("queue1", result.Properties.Action.QueueMessage.QueueName);
                Assert.Equal("some message!", result.Properties.Action.QueueMessage.Message);
                Assert.Null(result.Properties.Action.QueueMessage.SasToken);
                Assert.Equal(RetryType.Fixed, result.Properties.Action.RetryPolicy.RetryType);
                Assert.Equal(2, result.Properties.Action.RetryPolicy.RetryCount);
                Assert.Equal(TimeSpan.FromMinutes(1), result.Properties.Action.RetryPolicy.RetryInterval);
                Assert.Equal(JobActionType.Http, result.Properties.Action.ErrorAction.Type);
                Assert.Equal("http://www.bing.com/", result.Properties.Action.ErrorAction.Request.Uri);
                Assert.Equal("GET", result.Properties.Action.ErrorAction.Request.Method);
                Assert.Equal(JobState.Enabled, result.Properties.State);
                Assert.Equal(RecurrenceFrequency.Month, result.Properties.Recurrence.Frequency);
                Assert.Equal(1, result.Properties.Recurrence.Interval);
                Assert.Equal(10000, result.Properties.Recurrence.Count);
                Assert.Equal(new DateTime(2015, 10, 10, 10, 10, 10, DateTimeKind.Utc), result.Properties.Recurrence.EndTime);
                Assert.Equal(2, result.Properties.Recurrence.Schedule.MonthlyOccurrences.Count);
                Assert.Equal(JobScheduleDay.Monday, result.Properties.Recurrence.Schedule.MonthlyOccurrences[0].Day);
                Assert.Equal(1, result.Properties.Recurrence.Schedule.MonthlyOccurrences[0].Occurrence);
                Assert.Equal(JobScheduleDay.Friday, result.Properties.Recurrence.Schedule.MonthlyOccurrences[1].Day);
                Assert.Equal(1, result.Properties.Recurrence.Schedule.MonthlyOccurrences[1].Occurrence);
                Assert.Equal(new List<int?>() { 5, 10, 15, 20 }, result.Properties.Recurrence.Schedule.Hours);
                Assert.Equal(new List<int?>() { 0, 10, 20, 30, 40, 50 }, result.Properties.Recurrence.Schedule.Minutes);
                Assert.Null(result.Properties.Status.LastExecutionTime);
                Assert.Equal(0, result.Properties.Status.ExecutionCount);
                Assert.Equal(0, result.Properties.Status.FailureCount);
                Assert.Equal(0, result.Properties.Status.FaultedCount);

                var getResult = client.Jobs.Get(resourceGroupName, jobCollectionName, jobName);

                Assert.Equal(type, getResult.Type);
                Assert.Equal(jobDefinitionname, getResult.Name);
                Assert.Equal(JobActionType.StorageQueue, getResult.Properties.Action.Type);
                Assert.Equal("schedulersdktest", getResult.Properties.Action.QueueMessage.StorageAccount);
                Assert.Equal("queue1", getResult.Properties.Action.QueueMessage.QueueName);
                Assert.Equal("some message!", getResult.Properties.Action.QueueMessage.Message);
                Assert.Null(getResult.Properties.Action.QueueMessage.SasToken);
                Assert.Equal(RetryType.Fixed, getResult.Properties.Action.RetryPolicy.RetryType);
                Assert.Equal(2, getResult.Properties.Action.RetryPolicy.RetryCount);
                Assert.Equal(TimeSpan.FromMinutes(1), getResult.Properties.Action.RetryPolicy.RetryInterval);
                Assert.Equal(JobActionType.Http, getResult.Properties.Action.ErrorAction.Type);
                Assert.Equal("http://www.bing.com/", getResult.Properties.Action.ErrorAction.Request.Uri);
                Assert.Equal("GET", getResult.Properties.Action.ErrorAction.Request.Method);
                Assert.Equal(JobState.Enabled, getResult.Properties.State);
                Assert.Equal(RecurrenceFrequency.Month, getResult.Properties.Recurrence.Frequency);
                Assert.Equal(1, getResult.Properties.Recurrence.Interval);
                Assert.Equal(10000, getResult.Properties.Recurrence.Count);
                Assert.Equal(new DateTime(2015, 10, 10, 10, 10, 10, DateTimeKind.Utc), getResult.Properties.Recurrence.EndTime);
                Assert.Equal(2, getResult.Properties.Recurrence.Schedule.MonthlyOccurrences.Count);
                Assert.Equal(JobScheduleDay.Monday, getResult.Properties.Recurrence.Schedule.MonthlyOccurrences[0].Day);
                Assert.Equal(1, getResult.Properties.Recurrence.Schedule.MonthlyOccurrences[0].Occurrence);
                Assert.Equal(JobScheduleDay.Friday, getResult.Properties.Recurrence.Schedule.MonthlyOccurrences[1].Day);
                Assert.Equal(1, getResult.Properties.Recurrence.Schedule.MonthlyOccurrences[1].Occurrence);
                Assert.Equal(new List<int?>() { 5, 10, 15, 20 }, getResult.Properties.Recurrence.Schedule.Hours);
                Assert.Equal(new List<int?>() { 0, 10, 20, 30, 40, 50 }, getResult.Properties.Recurrence.Schedule.Minutes);
                Assert.Null(getResult.Properties.Status.LastExecutionTime);
                Assert.Equal(0, getResult.Properties.Status.ExecutionCount);
                Assert.Equal(0, getResult.Properties.Status.FailureCount);
                Assert.Equal(0, getResult.Properties.Status.FaultedCount);

                client.JobCollections.Delete(resourceGroupName, jobCollectionName);
            }
        }

        [Fact]
        public void Scenario_JobCreateUpdateDeleteHttpJob()
        {
            using (MockContext context = MockContext.Start())
            {
                const string jobName = "j1";
                string jobDefinitionname = string.Format("{0}/{1}", jobCollectionName, jobName);
                string id = string.Format("/subscriptions/{0}/resourceGroups/{1}/providers/Microsoft.Scheduler/jobCollections/{2}/jobs/{3}", subscriptionId, resourceGroupName, jobCollectionName, jobName);

                var client = TestBase.GetServiceClient<SchedulerManagementClient>();
                this.CreateJobCollection(client);

                var header = new Dictionary<string, string>();
                header.Add("content-type", "application/xml");

                var result = client.Jobs.CreateOrUpdate(
                    resourceGroupName: resourceGroupName,
                    jobCollectionName: jobCollectionName,
                    jobName: jobName,
                    job: new JobDefinition()
                    {
                        Properties = new JobProperties()
                        {
                            StartTime = new DateTime(2015, 7, 13),
                            Action = new JobAction()
                            {
                                Type = JobActionType.Http,
                                Request = new HttpRequest()
                                {
                                    Uri = "http://www.bing.com/",
                                    Method = "GET",
                                    Body = "some body message!",
                                    Headers = header,
                                },
                                RetryPolicy = new RetryPolicy()
                                {
                                    RetryType = RetryType.Fixed,
                                    RetryCount = 2,
                                    RetryInterval = TimeSpan.FromMinutes(1),
                                },
                                ErrorAction = new JobErrorAction()
                                {
                                    Type = JobActionType.StorageQueue,
                                    QueueMessage = new StorageQueueMessage()
                                    {
                                        StorageAccount = "schedulersdktest",
                                        QueueName = "queue1",
                                        Message = "some message!",
                                        SasToken = "lMyYwRg47zzabQvrL1fl0VtFfFCYi7YV80zAbrqT6H9iyj7N4duNHN0Cf7HecpResRCFtZhoCRrFwTIOwJKLhw==",
                                    }
                                }
                            },
                            Recurrence = new JobRecurrence()
                            {
                                Frequency = RecurrenceFrequency.Week,
                                Interval = 1,
                                Count = 10000,
                                EndTime = new DateTime(2015, 10, 10, 10, 10, 10, DateTimeKind.Utc),
                            },
                            State = JobState.Enabled,
                        }
                    });

                Assert.Equal(id, result.Id);
                Assert.Equal(type, result.Type);
                Assert.Equal(jobDefinitionname, result.Name);
                Assert.Equal(JobActionType.Http, result.Properties.Action.Type);
                Assert.Equal("http://www.bing.com/", result.Properties.Action.Request.Uri);
                Assert.Equal("GET", result.Properties.Action.Request.Method);
                Assert.Equal("some body message!", result.Properties.Action.Request.Body);
                Assert.Equal(header, result.Properties.Action.Request.Headers);
                Assert.Equal(RetryType.Fixed, result.Properties.Action.RetryPolicy.RetryType);
                Assert.Equal(2, result.Properties.Action.RetryPolicy.RetryCount);
                Assert.Equal(TimeSpan.FromMinutes(1), result.Properties.Action.RetryPolicy.RetryInterval);
                Assert.Equal(JobActionType.StorageQueue, result.Properties.Action.ErrorAction.Type);
                Assert.Equal("schedulersdktest", result.Properties.Action.ErrorAction.QueueMessage.StorageAccount);
                Assert.Equal("queue1", result.Properties.Action.ErrorAction.QueueMessage.QueueName);
                Assert.Equal("some message!", result.Properties.Action.ErrorAction.QueueMessage.Message);
                Assert.Equal("lMyYwRg47zzabQvrL1fl0VtFfFCYi7YV80zAbrqT6H9iyj7N4duNHN0Cf7HecpResRCFtZhoCRrFwTIOwJKLhw==", result.Properties.Action.ErrorAction.QueueMessage.SasToken);
                Assert.Equal(JobState.Enabled, result.Properties.State);
                Assert.Equal(RecurrenceFrequency.Week, result.Properties.Recurrence.Frequency);
                Assert.Equal(1, result.Properties.Recurrence.Interval);
                Assert.Equal(10000, result.Properties.Recurrence.Count);
                Assert.Equal(new DateTime(2015, 10, 10, 10, 10, 10, DateTimeKind.Utc), result.Properties.Recurrence.EndTime);
                Assert.Null(result.Properties.Status.LastExecutionTime);
                Assert.Equal(0, result.Properties.Status.ExecutionCount);
                Assert.Equal(0, result.Properties.Status.FailureCount);
                Assert.Equal(0, result.Properties.Status.FaultedCount);

                var updateResult = client.Jobs.CreateOrUpdate(
                    resourceGroupName: resourceGroupName,
                    jobCollectionName: jobCollectionName,
                    jobName: jobName,
                    job: new JobDefinition()
                    {
                        Properties = new JobProperties()
                        {
                            StartTime = new DateTime(2015, 7, 13),
                            Action = new JobAction()
                            {
                                Type = JobActionType.Http,
                                Request = new HttpRequest()
                                {
                                    Uri = "http://www.bing.com/",
                                    Method = "GET",
                                }
                            },
                            State = JobState.Disabled,
                        }
                    });

                Assert.Equal(id, updateResult.Id);
                Assert.Equal(type, updateResult.Type);
                Assert.Equal(jobDefinitionname, updateResult.Name);
                Assert.Equal(JobActionType.Http, updateResult.Properties.Action.Type);
                Assert.Equal("http://www.bing.com/", updateResult.Properties.Action.Request.Uri);
                Assert.Equal("GET", updateResult.Properties.Action.Request.Method);
                Assert.Null(updateResult.Properties.Action.Request.Body);
                Assert.Null(updateResult.Properties.Action.RetryPolicy);
                Assert.Null(updateResult.Properties.Action.ErrorAction);
                Assert.Equal(JobState.Disabled, updateResult.Properties.State);
                Assert.Null(updateResult.Properties.Recurrence);
                Assert.Null(updateResult.Properties.Status);

                client.JobCollections.Delete(resourceGroupName, jobCollectionName);
            }
        }

        [Fact]
        public void Scenario_JobCreateHttpJobWithBasicAuth()
        {
            using (MockContext context = MockContext.Start())
            {
                const string jobName = "j1";
                string jobDefinitionname = string.Format("{0}/{1}", jobCollectionName, jobName);
                string id = string.Format("/subscriptions/{0}/resourceGroups/{1}/providers/Microsoft.Scheduler/jobCollections/{2}/jobs/{3}", subscriptionId, resourceGroupName, jobCollectionName, jobName);

                var client = TestBase.GetServiceClient<SchedulerManagementClient>();
                this.CreateJobCollection(client);

                var header = new Dictionary<string, string>();
                header.Add("content-type", "application/xml");

                var result = client.Jobs.CreateOrUpdate(
                    resourceGroupName: resourceGroupName,
                    jobCollectionName: jobCollectionName,
                    jobName: jobName,
                    job: new JobDefinition()
                    {
                        Properties = new JobProperties()
                        {
                            StartTime = new DateTime(2015, 7, 13),
                            Action = new JobAction()
                            {
                                Type = JobActionType.Http,
                                Request = new HttpRequest()
                                {
                                    Uri = "http://www.bing.com/",
                                    Method = "GET",
                                    Body = "some body message!",
                                    Headers = header,
                                    HttpAuthentication = new BasicAuthentication() 
                                    { 
                                        Username = "username",
                                        Password = "pasworrd",
                                        Type = HttpAuthenticationType.Basic,
                                    }
                                },
                                RetryPolicy = new RetryPolicy()
                                {
                                    RetryType = RetryType.Fixed,
                                    RetryCount = 2,
                                    RetryInterval = TimeSpan.FromMinutes(1),
                                },
                                ErrorAction = new JobErrorAction()
                                {
                                    Type = JobActionType.StorageQueue,
                                    QueueMessage = new StorageQueueMessage()
                                    {
                                        StorageAccount = "schedulersdktest",
                                        QueueName = "queue1",
                                        Message = "some message!",
                                        SasToken = "lMyYwRg47zzabQvrL1fl0VtFfFCYi7YV80zAbrqT6H9iyj7N4duNHN0Cf7HecpResRCFtZhoCRrFwTIOwJKLhw==",
                                    }
                                }
                            },
                            Recurrence = new JobRecurrence()
                            {
                                Frequency = RecurrenceFrequency.Week,
                                Interval = 1,
                                Count = 10000,
                                EndTime = new DateTime(2015, 10, 10, 10, 10, 10, DateTimeKind.Utc),
                            },
                            State = JobState.Enabled,
                        }
                    });

                Assert.Equal(id, result.Id);
                Assert.Equal(type, result.Type);
                Assert.Equal(jobDefinitionname, result.Name);
                Assert.Equal(JobActionType.Http, result.Properties.Action.Type);
                Assert.Equal("http://www.bing.com/", result.Properties.Action.Request.Uri);
                Assert.Equal("GET", result.Properties.Action.Request.Method);
                Assert.Equal("some body message!", result.Properties.Action.Request.Body);
                Assert.Equal(header, result.Properties.Action.Request.Headers);
                Assert.Null(result.Properties.Action.Request.HttpAuthentication);
                Assert.Equal(RetryType.Fixed, result.Properties.Action.RetryPolicy.RetryType);
                Assert.Equal(2, result.Properties.Action.RetryPolicy.RetryCount);
                Assert.Equal(TimeSpan.FromMinutes(1), result.Properties.Action.RetryPolicy.RetryInterval);
                Assert.Equal(JobActionType.StorageQueue, result.Properties.Action.ErrorAction.Type);
                Assert.Equal("schedulersdktest", result.Properties.Action.ErrorAction.QueueMessage.StorageAccount);
                Assert.Equal("queue1", result.Properties.Action.ErrorAction.QueueMessage.QueueName);
                Assert.Equal("some message!", result.Properties.Action.ErrorAction.QueueMessage.Message);
                Assert.Equal("lMyYwRg47zzabQvrL1fl0VtFfFCYi7YV80zAbrqT6H9iyj7N4duNHN0Cf7HecpResRCFtZhoCRrFwTIOwJKLhw==", result.Properties.Action.ErrorAction.QueueMessage.SasToken);
                Assert.Equal(JobState.Enabled, result.Properties.State);
                Assert.Equal(RecurrenceFrequency.Week, result.Properties.Recurrence.Frequency);
                Assert.Equal(1, result.Properties.Recurrence.Interval);
                Assert.Equal(10000, result.Properties.Recurrence.Count);
                Assert.Equal(new DateTime(2015, 10, 10, 10, 10, 10, DateTimeKind.Utc), result.Properties.Recurrence.EndTime);
                Assert.Null(result.Properties.Status.LastExecutionTime);
                Assert.Equal(0, result.Properties.Status.ExecutionCount);
                Assert.Equal(0, result.Properties.Status.FailureCount);
                Assert.Equal(0, result.Properties.Status.FaultedCount);

                var updateResult = client.Jobs.CreateOrUpdate(
                    resourceGroupName: resourceGroupName,
                    jobCollectionName: jobCollectionName,
                    jobName: jobName,
                    job: new JobDefinition()
                    {
                        Properties = new JobProperties()
                        {
                            StartTime = new DateTime(2015, 7, 13),
                            Action = new JobAction()
                            {
                                Type = JobActionType.Http,
                                Request = new HttpRequest()
                                {
                                    Uri = "http://www.bing.com/",
                                    Method = "GET",
                                }
                            },
                            State = JobState.Disabled,
                        }
                    });

                Assert.Equal(id, updateResult.Id);
                Assert.Equal(type, updateResult.Type);
                Assert.Equal(jobDefinitionname, updateResult.Name);
                Assert.Equal(JobActionType.Http, updateResult.Properties.Action.Type);
                Assert.Equal("http://www.bing.com/", updateResult.Properties.Action.Request.Uri);
                Assert.Equal("GET", updateResult.Properties.Action.Request.Method);
                Assert.Null(updateResult.Properties.Action.Request.Body);
                Assert.Null(updateResult.Properties.Action.RetryPolicy);
                Assert.Null(updateResult.Properties.Action.ErrorAction);
                Assert.Equal(JobState.Disabled, updateResult.Properties.State);
                Assert.Null(updateResult.Properties.Recurrence);
                Assert.Null(updateResult.Properties.Status);

                client.JobCollections.Delete(resourceGroupName, jobCollectionName);
            }
        }

        [Fact]
        public void Scenario_JobCreateHttpJobWithOAuth()
        {
            using (MockContext context = MockContext.Start())
            {
                const string jobName = "j1";
                string jobDefinitionname = string.Format("{0}/{1}", jobCollectionName, jobName);
                string id = string.Format("/subscriptions/{0}/resourceGroups/{1}/providers/Microsoft.Scheduler/jobCollections/{2}/jobs/{3}", subscriptionId, resourceGroupName, jobCollectionName, jobName);

                var client = TestBase.GetServiceClient<SchedulerManagementClient>();
                this.CreateJobCollection(client);

                var header = new Dictionary<string, string>();
                header.Add("content-type", "application/xml");

                var result = client.Jobs.CreateOrUpdate(
                    resourceGroupName: resourceGroupName,
                    jobCollectionName: jobCollectionName,
                    jobName: jobName,
                    job: new JobDefinition()
                    {
                        Properties = new JobProperties()
                        {
                            StartTime = new DateTime(2015, 7, 13),
                            Action = new JobAction()
                            {
                                Type = JobActionType.Http,
                                Request = new HttpRequest()
                                {
                                    Uri = "http://www.bing.com/",
                                    Method = "GET",
                                    Body = "some body message!",
                                    Headers = header,
                                    HttpAuthentication = new OAuthAuthentication()
                                    {
                                        Secret = "secret",
                                        Audience = "audience",
                                        ClientId = "clientid",
                                        Tenant = "tenant",
                                        Type = HttpAuthenticationType.ActiveDirectoryOAuth,
                                    }
                                },
                                RetryPolicy = new RetryPolicy()
                                {
                                    RetryType = RetryType.Fixed,
                                    RetryCount = 2,
                                    RetryInterval = TimeSpan.FromMinutes(1),
                                },
                                ErrorAction = new JobErrorAction()
                                {
                                    Type = JobActionType.StorageQueue,
                                    QueueMessage = new StorageQueueMessage()
                                    {
                                        StorageAccount = "schedulersdktest",
                                        QueueName = "queue1",
                                        Message = "some message!",
                                        SasToken = "lMyYwRg47zzabQvrL1fl0VtFfFCYi7YV80zAbrqT6H9iyj7N4duNHN0Cf7HecpResRCFtZhoCRrFwTIOwJKLhw==",
                                    }
                                }
                            },
                            Recurrence = new JobRecurrence()
                            {
                                Frequency = RecurrenceFrequency.Week,
                                Interval = 1,
                                Count = 10000,
                                EndTime = new DateTime(2015, 10, 10, 10, 10, 10, DateTimeKind.Utc),
                            },
                            State = JobState.Enabled,
                        }
                    });

                Assert.Equal(id, result.Id);
                Assert.Equal(type, result.Type);
                Assert.Equal(jobDefinitionname, result.Name);
                Assert.Equal(JobActionType.Http, result.Properties.Action.Type);
                Assert.Equal("http://www.bing.com/", result.Properties.Action.Request.Uri);
                Assert.Equal("GET", result.Properties.Action.Request.Method);
                Assert.Equal("some body message!", result.Properties.Action.Request.Body);
                Assert.Equal(header, result.Properties.Action.Request.Headers);
                Assert.Null(result.Properties.Action.Request.HttpAuthentication);
                Assert.Equal(RetryType.Fixed, result.Properties.Action.RetryPolicy.RetryType);
                Assert.Equal(2, result.Properties.Action.RetryPolicy.RetryCount);
                Assert.Equal(TimeSpan.FromMinutes(1), result.Properties.Action.RetryPolicy.RetryInterval);
                Assert.Equal(JobActionType.StorageQueue, result.Properties.Action.ErrorAction.Type);
                Assert.Equal("schedulersdktest", result.Properties.Action.ErrorAction.QueueMessage.StorageAccount);
                Assert.Equal("queue1", result.Properties.Action.ErrorAction.QueueMessage.QueueName);
                Assert.Equal("some message!", result.Properties.Action.ErrorAction.QueueMessage.Message);
                Assert.Equal("lMyYwRg47zzabQvrL1fl0VtFfFCYi7YV80zAbrqT6H9iyj7N4duNHN0Cf7HecpResRCFtZhoCRrFwTIOwJKLhw==", result.Properties.Action.ErrorAction.QueueMessage.SasToken);
                Assert.Equal(JobState.Enabled, result.Properties.State);
                Assert.Equal(RecurrenceFrequency.Week, result.Properties.Recurrence.Frequency);
                Assert.Equal(1, result.Properties.Recurrence.Interval);
                Assert.Equal(10000, result.Properties.Recurrence.Count);
                Assert.Equal(new DateTime(2015, 10, 10, 10, 10, 10, DateTimeKind.Utc), result.Properties.Recurrence.EndTime);
                Assert.Null(result.Properties.Status.LastExecutionTime);
                Assert.Equal(0, result.Properties.Status.ExecutionCount);
                Assert.Equal(0, result.Properties.Status.FailureCount);
                Assert.Equal(0, result.Properties.Status.FaultedCount);

                var updateResult = client.Jobs.CreateOrUpdate(
                    resourceGroupName: resourceGroupName,
                    jobCollectionName: jobCollectionName,
                    jobName: jobName,
                    job: new JobDefinition()
                    {
                        Properties = new JobProperties()
                        {
                            StartTime = new DateTime(2015, 7, 13),
                            Action = new JobAction()
                            {
                                Type = JobActionType.Http,
                                Request = new HttpRequest()
                                {
                                    Uri = "http://www.bing.com/",
                                    Method = "GET",
                                }
                            },
                            State = JobState.Disabled,
                        }
                    });

                Assert.Equal(id, updateResult.Id);
                Assert.Equal(type, updateResult.Type);
                Assert.Equal(jobDefinitionname, updateResult.Name);
                Assert.Equal(JobActionType.Http, updateResult.Properties.Action.Type);
                Assert.Equal("http://www.bing.com/", updateResult.Properties.Action.Request.Uri);
                Assert.Equal("GET", updateResult.Properties.Action.Request.Method);
                Assert.Null(updateResult.Properties.Action.Request.Body);
                Assert.Null(updateResult.Properties.Action.RetryPolicy);
                Assert.Null(updateResult.Properties.Action.ErrorAction);
                Assert.Equal(JobState.Disabled, updateResult.Properties.State);
                Assert.Null(updateResult.Properties.Recurrence);
                Assert.Null(updateResult.Properties.Status);

                client.JobCollections.Delete(resourceGroupName, jobCollectionName);
            }
        }

        [Fact]
        public void Scenario_JobCreateHttpJobWithClientCertAuth()
        {
            using (MockContext context = MockContext.Start())
            {
                const string jobName = "j1";
                string jobDefinitionname = string.Format("{0}/{1}", jobCollectionName, jobName);
                string id = string.Format("/subscriptions/{0}/resourceGroups/{1}/providers/Microsoft.Scheduler/jobCollections/{2}/jobs/{3}", subscriptionId, resourceGroupName, jobCollectionName, jobName);

                var client = TestBase.GetServiceClient<SchedulerManagementClient>();
                this.CreateJobCollection(client);

                var header = new Dictionary<string, string>();
                header.Add("content-type", "application/xml");

                var result = client.Jobs.CreateOrUpdate(
                    resourceGroupName: resourceGroupName,
                    jobCollectionName: jobCollectionName,
                    jobName: jobName,
                    job: new JobDefinition()
                    {
                        Properties = new JobProperties()
                        {
                            StartTime = new DateTime(2015, 7, 13),
                            Action = new JobAction()
                            {
                                Type = JobActionType.Http,
                                Request = new HttpRequest()
                                {
                                    Uri = "http://www.bing.com/",
                                    Method = "GET",
                                    Body = "some body message!",
                                    Headers = header,
                                    HttpAuthentication = new ClientCertAuthentication()
                                    {
                                        CertificateExpirationDate = DateTime.UtcNow.AddDays(90),
                                        CertificateSubjectName = "subjectName",
                                        CertificateThumbprint = "thumbprint",
                                        Password = "password",
                                        Pfx = "pfx",
                                        Type = HttpAuthenticationType.ClientCertificate,
                                    }
                                },
                                RetryPolicy = new RetryPolicy()
                                {
                                    RetryType = RetryType.Fixed,
                                    RetryCount = 2,
                                    RetryInterval = TimeSpan.FromMinutes(1),
                                },
                                ErrorAction = new JobErrorAction()
                                {
                                    Type = JobActionType.StorageQueue,
                                    QueueMessage = new StorageQueueMessage()
                                    {
                                        StorageAccount = "schedulersdktest",
                                        QueueName = "queue1",
                                        Message = "some message!",
                                        SasToken = "lMyYwRg47zzabQvrL1fl0VtFfFCYi7YV80zAbrqT6H9iyj7N4duNHN0Cf7HecpResRCFtZhoCRrFwTIOwJKLhw==",
                                    }
                                }
                            },
                            Recurrence = new JobRecurrence()
                            {
                                Frequency = RecurrenceFrequency.Week,
                                Interval = 1,
                                Count = 10000,
                                EndTime = new DateTime(2015, 10, 10, 10, 10, 10, DateTimeKind.Utc),
                            },
                            State = JobState.Enabled,
                        }
                    });

                Assert.Equal(id, result.Id);
                Assert.Equal(type, result.Type);
                Assert.Equal(jobDefinitionname, result.Name);
                Assert.Equal(JobActionType.Http, result.Properties.Action.Type);
                Assert.Equal("http://www.bing.com/", result.Properties.Action.Request.Uri);
                Assert.Equal("GET", result.Properties.Action.Request.Method);
                Assert.Equal("some body message!", result.Properties.Action.Request.Body);
                Assert.Equal(header, result.Properties.Action.Request.Headers);
                Assert.Null(result.Properties.Action.Request.HttpAuthentication);
                Assert.Equal(RetryType.Fixed, result.Properties.Action.RetryPolicy.RetryType);
                Assert.Equal(2, result.Properties.Action.RetryPolicy.RetryCount);
                Assert.Equal(TimeSpan.FromMinutes(1), result.Properties.Action.RetryPolicy.RetryInterval);
                Assert.Equal(JobActionType.StorageQueue, result.Properties.Action.ErrorAction.Type);
                Assert.Equal("schedulersdktest", result.Properties.Action.ErrorAction.QueueMessage.StorageAccount);
                Assert.Equal("queue1", result.Properties.Action.ErrorAction.QueueMessage.QueueName);
                Assert.Equal("some message!", result.Properties.Action.ErrorAction.QueueMessage.Message);
                Assert.Equal("lMyYwRg47zzabQvrL1fl0VtFfFCYi7YV80zAbrqT6H9iyj7N4duNHN0Cf7HecpResRCFtZhoCRrFwTIOwJKLhw==", result.Properties.Action.ErrorAction.QueueMessage.SasToken);
                Assert.Equal(JobState.Enabled, result.Properties.State);
                Assert.Equal(RecurrenceFrequency.Week, result.Properties.Recurrence.Frequency);
                Assert.Equal(1, result.Properties.Recurrence.Interval);
                Assert.Equal(10000, result.Properties.Recurrence.Count);
                Assert.Equal(new DateTime(2015, 10, 10, 10, 10, 10, DateTimeKind.Utc), result.Properties.Recurrence.EndTime);
                Assert.Null(result.Properties.Status.LastExecutionTime);
                Assert.Equal(0, result.Properties.Status.ExecutionCount);
                Assert.Equal(0, result.Properties.Status.FailureCount);
                Assert.Equal(0, result.Properties.Status.FaultedCount);

                var updateResult = client.Jobs.CreateOrUpdate(
                    resourceGroupName: resourceGroupName,
                    jobCollectionName: jobCollectionName,
                    jobName: jobName,
                    job: new JobDefinition()
                    {
                        Properties = new JobProperties()
                        {
                            StartTime = new DateTime(2015, 7, 13),
                            Action = new JobAction()
                            {
                                Type = JobActionType.Http,
                                Request = new HttpRequest()
                                {
                                    Uri = "http://www.bing.com/",
                                    Method = "GET",
                                }
                            },
                            State = JobState.Disabled,
                        }
                    });

                Assert.Equal(id, updateResult.Id);
                Assert.Equal(type, updateResult.Type);
                Assert.Equal(jobDefinitionname, updateResult.Name);
                Assert.Equal(JobActionType.Http, updateResult.Properties.Action.Type);
                Assert.Equal("http://www.bing.com/", updateResult.Properties.Action.Request.Uri);
                Assert.Equal("GET", updateResult.Properties.Action.Request.Method);
                Assert.Null(updateResult.Properties.Action.Request.Body);
                Assert.Null(updateResult.Properties.Action.RetryPolicy);
                Assert.Null(updateResult.Properties.Action.ErrorAction);
                Assert.Equal(JobState.Disabled, updateResult.Properties.State);
                Assert.Null(updateResult.Properties.Recurrence);
                Assert.Null(updateResult.Properties.Status);

                client.JobCollections.Delete(resourceGroupName, jobCollectionName);
            }
        }

        [Fact]
        public void Scenario_JobCreatePatchDeleteStorageJob()
        {
            using (MockContext context = MockContext.Start())
            {
                const string jobName = "j1";
                string jobDefinitionname = string.Format("{0}/{1}", jobCollectionName, jobName);
                string id = string.Format("/subscriptions/{0}/resourceGroups/{1}/providers/Microsoft.Scheduler/jobCollections/{2}/jobs/{3}", subscriptionId, resourceGroupName, jobCollectionName, jobName);

                var client = TestBase.GetServiceClient<SchedulerManagementClient>();
                this.CreateJobCollection(client);

                var result = client.Jobs.CreateOrUpdate(
                    resourceGroupName: resourceGroupName,
                    jobCollectionName: jobCollectionName,
                    jobName: jobName,
                    job: new JobDefinition()
                    {
                        Properties = new JobProperties()
                        {
                            StartTime = new DateTime(2015, 7, 13),
                            Action = new JobAction()
                            {
                                Type = JobActionType.StorageQueue,
                                QueueMessage = new StorageQueueMessage()
                                {
                                    StorageAccount = "schedulersdktest",
                                    QueueName = "queue1",
                                    Message = "some message!",
                                    SasToken = "lMyYwRg47zzabQvrL1fl0VtFfFCYi7YV80zAbrqT6H9iyj7N4duNHN0Cf7HecpResRCFtZhoCRrFwTIOwJKLhw==",
                                },
                                RetryPolicy = new RetryPolicy()
                                {
                                    RetryType = RetryType.Fixed,
                                    RetryCount = 2,
                                    RetryInterval = TimeSpan.FromMinutes(1),
                                },
                                ErrorAction = new JobErrorAction()
                                {
                                    Type = JobActionType.Http,
                                    Request = new HttpRequest()
                                    {
                                        Uri = "http://www.bing.com/",
                                        Method = "GET",
                                    },
                                }
                            },
                            Recurrence = new JobRecurrence()
                            {
                                Frequency = RecurrenceFrequency.Week,
                                Interval = 1,
                                Count = 10000,
                                EndTime = new DateTime(2015, 10, 10, 10, 10, 10, DateTimeKind.Utc),
                            },
                            State = JobState.Enabled,
                        }
                    });

                Assert.Equal(id, result.Id);
                Assert.Equal(type, result.Type);
                Assert.Equal(jobDefinitionname, result.Name);
                Assert.Equal(JobActionType.StorageQueue, result.Properties.Action.Type);
                Assert.Equal("schedulersdktest", result.Properties.Action.QueueMessage.StorageAccount);
                Assert.Equal("queue1", result.Properties.Action.QueueMessage.QueueName);
                Assert.Equal("some message!", result.Properties.Action.QueueMessage.Message);
                Assert.Null(result.Properties.Action.QueueMessage.SasToken);
                Assert.Equal(RetryType.Fixed, result.Properties.Action.RetryPolicy.RetryType);
                Assert.Equal(2, result.Properties.Action.RetryPolicy.RetryCount);
                Assert.Equal(TimeSpan.FromMinutes(1), result.Properties.Action.RetryPolicy.RetryInterval);
                Assert.Equal(JobActionType.Http, result.Properties.Action.ErrorAction.Type);
                Assert.Equal("http://www.bing.com/", result.Properties.Action.ErrorAction.Request.Uri);
                Assert.Equal("GET", result.Properties.Action.ErrorAction.Request.Method);
                Assert.Equal(JobState.Enabled, result.Properties.State);
                Assert.Equal(RecurrenceFrequency.Week, result.Properties.Recurrence.Frequency);
                Assert.Equal(1, result.Properties.Recurrence.Interval);
                Assert.Equal(10000, result.Properties.Recurrence.Count);
                Assert.Equal(new DateTime(2015, 10, 10, 10, 10, 10, DateTimeKind.Utc), result.Properties.Recurrence.EndTime);
                Assert.Null(result.Properties.Status.LastExecutionTime);
                Assert.Equal(0, result.Properties.Status.ExecutionCount);
                Assert.Equal(0, result.Properties.Status.FailureCount);
                Assert.Equal(0, result.Properties.Status.FaultedCount);

                var patchResult = client.Jobs.Patch(
                    resourceGroupName: resourceGroupName,
                    jobCollectionName: jobCollectionName,
                    jobName: jobName,
                    job: new JobDefinition()
                    {
                        Properties = new JobProperties()
                        {
                            StartTime = new DateTime(2015, 7, 14),
                            Recurrence = new JobRecurrence()
                            {
                                Frequency = RecurrenceFrequency.Day,
                                Interval = 1,
                            },
                        }
                    });

                Assert.Equal(type, patchResult.Type);
                Assert.Equal(jobDefinitionname, patchResult.Name);
                Assert.Equal(new DateTime(2015, 7, 14, 0, 0, 0, DateTimeKind.Utc), patchResult.Properties.StartTime);
                Assert.Equal(JobActionType.StorageQueue, patchResult.Properties.Action.Type);
                Assert.Equal("schedulersdktest", patchResult.Properties.Action.QueueMessage.StorageAccount);
                Assert.Equal("queue1", patchResult.Properties.Action.QueueMessage.QueueName);
                Assert.Equal("some message!", patchResult.Properties.Action.QueueMessage.Message);
                Assert.Null(patchResult.Properties.Action.QueueMessage.SasToken);
                Assert.Equal(RetryType.Fixed, patchResult.Properties.Action.RetryPolicy.RetryType);
                Assert.Equal(2, patchResult.Properties.Action.RetryPolicy.RetryCount);
                Assert.Equal(TimeSpan.FromMinutes(1), patchResult.Properties.Action.RetryPolicy.RetryInterval);
                Assert.Equal(JobActionType.Http, patchResult.Properties.Action.ErrorAction.Type);
                Assert.Equal("http://www.bing.com/", patchResult.Properties.Action.ErrorAction.Request.Uri);
                Assert.Equal("GET", patchResult.Properties.Action.ErrorAction.Request.Method);
                Assert.Equal(JobState.Enabled, patchResult.Properties.State);
                Assert.Equal(RecurrenceFrequency.Day, patchResult.Properties.Recurrence.Frequency);
                Assert.Equal(1, patchResult.Properties.Recurrence.Interval);
                Assert.Equal(10000, patchResult.Properties.Recurrence.Count);
                Assert.Equal(new DateTime(2015, 10, 10, 10, 10, 10, DateTimeKind.Utc), patchResult.Properties.Recurrence.EndTime);
                Assert.Null(patchResult.Properties.Status.LastExecutionTime);
                Assert.Equal(0, patchResult.Properties.Status.ExecutionCount);
                Assert.Equal(0, patchResult.Properties.Status.FailureCount);
                Assert.Equal(0, patchResult.Properties.Status.FaultedCount);

                client.JobCollections.Delete(resourceGroupName, jobCollectionName);
            }
        }

        [Fact]
        public void Scenario_JobList()
        {
            using (MockContext context = MockContext.Start())
            {
                const string jobName1 = "j1";
                const string jobName2 = "j2";
                string jobDefinitionName1 = string.Format("{0}/{1}", jobCollectionName, jobName1);
                string jobDefinitionName2 = string.Format("{0}/{1}", jobCollectionName, jobName2);
                string id1 = string.Format("/subscriptions/{0}/resourceGroups/{1}/providers/Microsoft.Scheduler/jobCollections/{2}/jobs/{3}", subscriptionId, resourceGroupName, jobCollectionName, jobName1);
                string id2 = string.Format("/subscriptions/{0}/resourceGroups/{1}/providers/Microsoft.Scheduler/jobCollections/{2}/jobs/{3}", subscriptionId, resourceGroupName, jobCollectionName, jobName2);

                var client = TestBase.GetServiceClient<SchedulerManagementClient>();
                this.CreateJobCollection(client);

                client.Jobs.CreateOrUpdate(
                    resourceGroupName: resourceGroupName,
                    jobCollectionName: jobCollectionName,
                    jobName: jobName1,
                    job: new JobDefinition()
                    {
                        Properties = new JobProperties()
                        {
                            StartTime = new DateTime(2015, 7, 13),
                            Action = new JobAction()
                            {
                                Type = JobActionType.Http,
                                Request = new HttpRequest()
                                {
                                    Uri = "http://www.bing.com/",
                                    Method = "GET",
                                }
                            },
                            State = JobState.Enabled,
                        }
                    });

                client.Jobs.CreateOrUpdate(
                    resourceGroupName: resourceGroupName,
                    jobCollectionName: jobCollectionName,
                    jobName: jobName2,
                    job: new JobDefinition()
                    {
                        Properties = new JobProperties()
                        {
                            StartTime = new DateTime(2015, 7, 14),
                            Action = new JobAction()
                            {
                                Type = JobActionType.Http,
                                Request = new HttpRequest()
                                {
                                    Uri = "http://www.google.com/",
                                    Method = "POST",
                                }
                            },
                            State = JobState.Disabled,
                        }
                    });


                var listResult = client.Jobs.List(resourceGroupName, jobCollectionName);

                Assert.Equal(2, listResult.Value.Count);

                var listResult1 = listResult.Value.Where(job => string.Compare(job.Id, id1) == 0).FirstOrDefault();
                var listResult2 = listResult.Value.Where(job => string.Compare(job.Id, id2) == 0).FirstOrDefault();

                Assert.Equal(jobDefinitionName1, listResult1.Name);
                Assert.Equal(new DateTime(2015, 7, 13, 0, 0, 0, DateTimeKind.Utc), listResult1.Properties.StartTime);
                Assert.Equal(JobActionType.Http, listResult1.Properties.Action.Type);
                Assert.Equal("http://www.bing.com/", listResult1.Properties.Action.Request.Uri);
                Assert.Equal("GET", listResult1.Properties.Action.Request.Method);
                Assert.Equal(JobState.Enabled, listResult1.Properties.State);

                Assert.Equal(jobDefinitionName2, listResult2.Name);
                Assert.Equal(new DateTime(2015, 7, 14, 0, 0, 0, DateTimeKind.Utc), listResult2.Properties.StartTime);
                Assert.Equal(JobActionType.Http, listResult2.Properties.Action.Type);
                Assert.Equal("http://www.google.com/", listResult2.Properties.Action.Request.Uri);
                Assert.Equal("POST", listResult2.Properties.Action.Request.Method);
                Assert.Equal(JobState.Disabled, listResult2.Properties.State);

                client.JobCollections.Delete(resourceGroupName, jobCollectionName);
            }
        }

        [Fact]
        public void Scenario_JobHistoryList()
        {
            using (MockContext context = MockContext.Start())
            {
                const string existingJobCollectionName = "sdk-test";
                const string existingJobName = "http_job";
                const string historyType = "Microsoft.Scheduler/jobCollections/jobs/history";
                string jobDefinitionName = string.Format("{0}/{1}", existingJobCollectionName, existingJobName);
                string id = string.Format("/subscriptions/{0}/resourceGroups/{1}/providers/Microsoft.Scheduler/jobCollections/{2}/jobs/{3}", subscriptionId, resourceGroupName, existingJobCollectionName, existingJobName);

                var client = TestBase.GetServiceClient<SchedulerManagementClient>();

                var listResult = client.Jobs.ListJobHistory(resourceGroupName, existingJobCollectionName, existingJobName);
                var listTopResult = client.Jobs.ListJobHistory(resourceGroupName, existingJobCollectionName, existingJobName, top: 5);
                var listSkipResult = client.Jobs.ListJobHistory(resourceGroupName, existingJobCollectionName, existingJobName, top: 5, skip: 5);
                
                Assert.True(listResult.Value.Count >= 0);
                Assert.True(listResult.Value[0].Id.Contains(id));
                Assert.True(listResult.Value[0].Name.Contains(jobDefinitionName));
                Assert.Equal(historyType, listResult.Value[0].Type);
                Assert.Equal(JobHistoryActionName.MainAction, listResult.Value[0].Properties.ActionName);
                Assert.NotNull(listResult.Value[0].Properties.EndTime);
                Assert.NotNull(listResult.Value[0].Properties.ExpectedExecutionTime);
                Assert.NotNull(listResult.Value[0].Properties.Message);
                Assert.True(listResult.Value[0].Properties.RepeatCount > 0);
                Assert.True(listResult.Value[0].Properties.RetryCount >= 0);
                Assert.NotNull(listResult.Value[0].Properties.StartTime);
                
                Assert.True(listTopResult.Value.Count == 5);
                Assert.Equal(listResult.Value[0].Id, listTopResult.Value[0].Id);
                Assert.Equal(listResult.Value[0].Name, listTopResult.Value[0].Name);
                Assert.Equal(listResult.Value[0].Type, listTopResult.Value[0].Type);
                Assert.Equal(listResult.Value[0].Properties.ActionName, listTopResult.Value[0].Properties.ActionName);
                Assert.Equal(listResult.Value[0].Properties.EndTime, listTopResult.Value[0].Properties.EndTime);
                Assert.Equal(listResult.Value[0].Properties.ExpectedExecutionTime, listTopResult.Value[0].Properties.ExpectedExecutionTime);
                Assert.Equal(listResult.Value[0].Properties.Message, listTopResult.Value[0].Properties.Message);
                Assert.Equal(listResult.Value[0].Properties.RepeatCount, listTopResult.Value[0].Properties.RepeatCount);
                Assert.Equal(listResult.Value[0].Properties.RetryCount, listTopResult.Value[0].Properties.RetryCount);
                Assert.Equal(listResult.Value[0].Properties.StartTime, listTopResult.Value[0].Properties.StartTime);

                Assert.True(listSkipResult.Value.Count == 5);
                Assert.True(listTopResult.Value[0].Properties.EndTime > listSkipResult.Value[0].Properties.EndTime);
                Assert.True(listTopResult.Value[0].Properties.ExpectedExecutionTime > listSkipResult.Value[0].Properties.ExpectedExecutionTime);
                Assert.True(listTopResult.Value[0].Properties.StartTime > listSkipResult.Value[0].Properties.StartTime);
            }
        }

        private void CreateJobCollection(SchedulerManagementClient client)
        {
            client.JobCollections.CreateOrUpdate(
                resourceGroupName: resourceGroupName,
                jobCollectionName: jobCollectionName,
                jobCollection: new JobCollectionDefinition()
                {
                    Name = jobCollectionName,
                    Location = location,
                    Properties = new JobCollectionProperties()
                    {
                        Sku = new Sku()
                        {
                            Name = SkuDefinition.Standard,
                        },
                        State = JobCollectionState.Enabled,
                        Quota = new JobCollectionQuota()
                        {
                            MaxJobCount = 50,
                            MaxRecurrence = new JobMaxRecurrence()
                            {
                                Frequency = RecurrenceFrequency.Minute,
                                Interval = 1,
                            }
                        }
                    }
                });
        }
    }
}