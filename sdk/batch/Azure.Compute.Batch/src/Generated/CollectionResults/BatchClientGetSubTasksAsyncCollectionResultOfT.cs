// Copyright (c) Microsoft Corporation. All rights reserved.
// Licensed under the MIT License.

// <auto-generated/>

#nullable disable

using System;
using System.Collections.Generic;
using System.Threading.Tasks;
using Azure;
using Azure.Core;
using Azure.Core.Pipeline;

namespace Azure.Compute.Batch
{
    internal partial class BatchClientGetSubTasksAsyncCollectionResultOfT : AsyncPageable<BatchSubtask>
    {
        private readonly BatchClient _client;
        private readonly string _jobId;
        private readonly string _taskId;
        private readonly TimeSpan? _timeOutInSeconds;
        private readonly DateTimeOffset? _ocpDate;
        private readonly IEnumerable<string> _select;
        private readonly RequestContext _context;

        /// <summary> Initializes a new instance of BatchClientGetSubTasksAsyncCollectionResultOfT, which is used to iterate over the pages of a collection. </summary>
        /// <param name="client"> The BatchClient client used to send requests. </param>
        /// <param name="jobId"> The ID of the Job. </param>
        /// <param name="taskId"> The ID of the Task. </param>
        /// <param name="timeOutInSeconds"> The maximum time that the server can spend processing the request, in seconds. The default is 30 seconds. If the value is larger than 30, the default will be used instead.". </param>
        /// <param name="ocpDate">
        /// The time the request was issued. Client libraries typically set this to the
        /// current system clock time; set it explicitly if you are calling the REST API
        /// directly.
        /// </param>
        /// <param name="select"> An OData $select clause. </param>
        /// <param name="context"> The request options, which can override default behaviors of the client pipeline on a per-call basis. </param>
        public BatchClientGetSubTasksAsyncCollectionResultOfT(BatchClient client, string jobId, string taskId, TimeSpan? timeOutInSeconds, DateTimeOffset? ocpDate, IEnumerable<string> @select, RequestContext context) : base(context?.CancellationToken ?? default)
        {
            _client = client;
            _jobId = jobId;
            _taskId = taskId;
            _timeOutInSeconds = timeOutInSeconds;
            _ocpDate = ocpDate;
            _select = @select;
            _context = context;
        }

        /// <summary> Gets the pages of BatchClientGetSubTasksAsyncCollectionResultOfT as an enumerable collection. </summary>
        /// <param name="continuationToken"> A continuation token indicating where to resume paging. </param>
        /// <param name="pageSizeHint"> The number of items per page. </param>
        /// <returns> The pages of BatchClientGetSubTasksAsyncCollectionResultOfT as an enumerable collection. </returns>
        public override async IAsyncEnumerable<Page<BatchSubtask>> AsPages(string continuationToken, int? pageSizeHint)
        {
            Uri nextPage = continuationToken != null ? new Uri(continuationToken) : null;
            while (true)
            {
                Response response = await GetNextResponseAsync(pageSizeHint, nextPage).ConfigureAwait(false);
                if (response is null)
                {
                    yield break;
                }
                BatchTaskListSubtasksResult result = (BatchTaskListSubtasksResult)response;
                yield return Page<BatchSubtask>.FromValues((IReadOnlyList<BatchSubtask>)result.Value, nextPage?.AbsoluteUri, response);
                nextPage = result.OdataNextLink;
                if (nextPage == null)
                {
                    yield break;
                }
            }
        }

        /// <summary> Get next page. </summary>
        /// <param name="pageSizeHint"> The number of items per page. </param>
        /// <param name="nextLink"> The next link to use for the next page of results. </param>
        private async ValueTask<Response> GetNextResponseAsync(int? pageSizeHint, Uri nextLink)
        {
            HttpMessage message = nextLink != null ? _client.CreateNextGetSubTasksRequest(nextLink, _jobId, _taskId, _timeOutInSeconds, _ocpDate, _select, _context) : _client.CreateGetSubTasksRequest(_jobId, _taskId, _timeOutInSeconds, _ocpDate, _select, _context);
            using DiagnosticScope scope = _client.ClientDiagnostics.CreateScope("BatchClient.GetSubTasks");
            scope.Start();
            try
            {
                return await _client.Pipeline.ProcessMessageAsync(message, _context).ConfigureAwait(false);
            }
            catch (Exception e)
            {
                scope.Failed(e);
                throw;
            }
        }
    }
}
