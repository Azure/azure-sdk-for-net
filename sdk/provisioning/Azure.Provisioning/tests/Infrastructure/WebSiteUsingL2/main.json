{
  "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.25.53.49325",
      "templateHash": "1302569993866915396"
    }
  },
  "parameters": {
    "sqlAdminPassword": {
      "type": "securestring",
      "metadata": {
        "description": "SQL Server administrator password"
      }
    },
    "appUserPassword": {
      "type": "securestring",
      "metadata": {
        "description": "Application user password"
      }
    }
  },
  "resources": [
    {
      "type": "Microsoft.Resources/resourceGroups",
      "apiVersion": "2023-07-01",
      "name": "rg-TEST",
      "location": "westus",
      "tags": {
        "azd-env-name": "TEST",
        "key": "value"
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "rg_TEST",
      "resourceGroup": "rg-TEST",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "sqlAdminPassword": {
            "value": "[parameters('sqlAdminPassword')]"
          },
          "appUserPassword": {
            "value": "[parameters('appUserPassword')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.25.53.49325",
              "templateHash": "15257118810642908366"
            }
          },
          "parameters": {
            "sqlAdminPassword": {
              "type": "securestring",
              "metadata": {
                "description": "SQL Server administrator password"
              }
            },
            "appUserPassword": {
              "type": "securestring",
              "metadata": {
                "description": "Application user password"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Web/serverfarms",
              "apiVersion": "2021-02-01",
              "name": "appServicePlan-TEST",
              "location": "westus",
              "sku": {
                "name": "B1"
              },
              "properties": {
                "reserved": true
              }
            },
            {
              "type": "Microsoft.KeyVault/vaults",
              "apiVersion": "2023-02-01",
              "name": "kv-TEST",
              "location": "westus",
              "properties": {
                "tenantId": "00000000-0000-0000-0000-000000000000",
                "sku": {
                  "name": "standard",
                  "family": "A"
                }
              }
            },
            {
              "type": "Microsoft.KeyVault/vaults/accessPolicies",
              "apiVersion": "2023-02-01",
              "name": "[format('{0}/{1}', 'kv-TEST', 'add')]",
              "properties": {
                "accessPolicies": [
                  {
                    "tenantId": "00000000-0000-0000-0000-000000000000",
                    "objectId": "[reference(resourceId('Microsoft.Web/sites', 'frontEnd-TEST'), '2021-02-01', 'full').identity.principalId]",
                    "permissions": {
                      "secrets": [
                        "get",
                        "list"
                      ]
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.KeyVault/vaults', 'kv-TEST')]",
                "[resourceId('Microsoft.Web/sites', 'frontEnd-TEST')]"
              ]
            },
            {
              "type": "Microsoft.KeyVault/vaults/secrets",
              "apiVersion": "2023-02-01",
              "name": "[format('{0}/{1}', 'kv-TEST', 'sqlAdminPassword-TEST')]",
              "properties": {
                "value": "[parameters('sqlAdminPassword')]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.KeyVault/vaults', 'kv-TEST')]"
              ]
            },
            {
              "type": "Microsoft.KeyVault/vaults/secrets",
              "apiVersion": "2023-02-01",
              "name": "[format('{0}/{1}', 'kv-TEST', 'appUserPassword-TEST')]",
              "properties": {
                "value": "[parameters('appUserPassword')]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.KeyVault/vaults', 'kv-TEST')]"
              ]
            },
            {
              "type": "Microsoft.KeyVault/vaults/secrets",
              "apiVersion": "2023-02-01",
              "name": "[format('{0}/{1}', 'kv-TEST', 'connectionString-TEST')]",
              "properties": {
                "value": "[format('Server={0}; Database={1}; User=appUser; Password={2}', reference(resourceId('Microsoft.Sql/servers', 'sqlserver-TEST'), '2022-08-01-preview').fullyQualifiedDomainName, 'db-TEST', parameters('appUserPassword'))]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.KeyVault/vaults', 'kv-TEST')]",
                "[resourceId('Microsoft.Sql/servers/databases', 'sqlserver-TEST', 'db-TEST')]",
                "[resourceId('Microsoft.Sql/servers', 'sqlserver-TEST')]"
              ]
            },
            {
              "type": "Microsoft.Web/sites",
              "apiVersion": "2021-02-01",
              "name": "frontEnd-TEST",
              "location": "westus",
              "identity": {},
              "kind": "app,linux",
              "properties": {
                "serverFarmId": "/subscriptions/00000000-0000-0000-0000-000000000000/resourceGroups/rg-TEST/providers/Microsoft.Web/serverfarms/appServicePlan-TEST",
                "siteConfig": {
                  "linuxFxVersion": "node|18-lts",
                  "alwaysOn": true,
                  "appCommandLine": "./entrypoint.sh -o ./env-config.js && pm2 serve /home/site/wwwroot --no-daemon --spa",
                  "experiments": {},
                  "cors": {
                    "allowedOrigins": [
                      "https://portal.azure.com",
                      "https://ms.portal.azure.com"
                    ]
                  },
                  "minTlsVersion": "1.2",
                  "ftpsState": "FtpsOnly"
                },
                "httpsOnly": true
              }
            },
            {
              "type": "Microsoft.Web/sites/config",
              "apiVersion": "2021-02-01",
              "name": "[format('{0}/{1}', 'frontEnd-TEST', 'appsettings')]",
              "dependsOn": [
                "[resourceId('Microsoft.Web/sites', 'frontEnd-TEST')]"
              ]
            },
            {
              "type": "Microsoft.Web/sites/config",
              "apiVersion": "2021-02-01",
              "name": "[format('{0}/{1}', 'frontEnd-TEST', 'logs')]",
              "properties": {
                "applicationLogs": {
                  "fileSystem": {
                    "level": "Verbose"
                  }
                },
                "httpLogs": {
                  "fileSystem": {
                    "retentionInMb": 35,
                    "retentionInDays": 1,
                    "enabled": true
                  }
                },
                "failedRequestsTracing": {
                  "enabled": true
                },
                "detailedErrorMessages": {
                  "enabled": true
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Web/sites', 'frontEnd-TEST')]"
              ]
            },
            {
              "type": "Microsoft.Sql/servers",
              "apiVersion": "2022-08-01-preview",
              "name": "sqlserver-TEST",
              "location": "westus",
              "properties": {
                "administratorLogin": "sqladmin",
                "administratorLoginPassword": "[parameters('sqlAdminPassword')]",
                "version": "12.0",
                "minimalTlsVersion": "1.2",
                "publicNetworkAccess": "Enabled"
              }
            },
            {
              "type": "Microsoft.Sql/servers/databases",
              "apiVersion": "2022-08-01-preview",
              "name": "[format('{0}/{1}', 'sqlserver-TEST', 'db-TEST')]",
              "location": "westus",
              "properties": {},
              "dependsOn": [
                "[resourceId('Microsoft.Sql/servers', 'sqlserver-TEST')]"
              ]
            },
            {
              "type": "Microsoft.Sql/servers/firewallRules",
              "apiVersion": "2020-11-01-preview",
              "name": "[format('{0}/{1}', 'sqlserver-TEST', 'firewallRule-TEST')]",
              "properties": {
                "startIpAddress": "0.0.0.1",
                "endIpAddress": "255.255.255.254"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Sql/servers', 'sqlserver-TEST')]"
              ]
            },
            {
              "type": "Microsoft.Resources/deploymentScripts",
              "apiVersion": "2020-10-01",
              "name": "cliScript-TEST",
              "location": "westus",
              "kind": "AzureCLI",
              "properties": {
                "cleanupPreference": "OnSuccess",
                "scriptContent": "wget https://github.com/microsoft/go-sqlcmd/releases/download/v0.8.1/sqlcmd-v0.8.1-linux-x64.tar.bz2\r\ntar x -f sqlcmd-v0.8.1-linux-x64.tar.bz2 -C .\r\ncat <<SCRIPT_END > ./initDb.sql\r\ndrop user ${APPUSERNAME}\r\ngo\r\ncreate user ${APPUSERNAME} with password = '${APPUSERPASSWORD}'\r\ngo\r\nalter role db_owner add member ${APPUSERNAME}\r\ngo\r\nSCRIPT_END\r\n./sqlcmd -S ${DBSERVER} -d ${DBNAME} -U ${SQLADMIN} -i ./initDb.sql",
                "environmentVariables": [
                  {
                    "name": "APPUSERNAME",
                    "value": "appUser"
                  },
                  {
                    "name": "APPUSERPASSWORD",
                    "secureValue": "_p_.appUserPassword"
                  },
                  {
                    "name": "DBNAME",
                    "value": "_p_.sqlDatabase_U7NzorRJT.name"
                  },
                  {
                    "name": "DBSERVER",
                    "value": "_p_.sqlServer_zjdvvB2wl.properties.fullyQualifiedDomainName"
                  },
                  {
                    "name": "SQLCMDPASSWORD",
                    "secureValue": "_p_.sqlAdminPassword"
                  },
                  {
                    "name": "SQLADMIN",
                    "value": "sqlAdmin"
                  }
                ],
                "retentionInterval": "PT1H",
                "timeout": "PT5M",
                "azCliVersion": "2.37.0"
              }
            },
            {
              "type": "Microsoft.Web/sites",
              "apiVersion": "2021-02-01",
              "name": "backEnd-TEST",
              "location": "westus",
              "identity": {},
              "kind": "app,linux",
              "properties": {
                "serverFarmId": "/subscriptions/00000000-0000-0000-0000-000000000000/resourceGroups/rg-TEST/providers/Microsoft.Web/serverfarms/appServicePlan-TEST",
                "siteConfig": {
                  "linuxFxVersion": "dotnetcore|6.0",
                  "alwaysOn": true,
                  "appCommandLine": "",
                  "experiments": {},
                  "cors": {
                    "allowedOrigins": [
                      "https://portal.azure.com",
                      "https://ms.portal.azure.com"
                    ]
                  },
                  "minTlsVersion": "1.2",
                  "ftpsState": "FtpsOnly"
                },
                "httpsOnly": true
              }
            },
            {
              "type": "Microsoft.Web/sites/config",
              "apiVersion": "2021-02-01",
              "name": "[format('{0}/{1}', 'backEnd-TEST', 'appsettings')]",
              "properties": {
                "SCM_DO_BUILD_DURING_DEPLOYMENT": "False",
                "ENABLE_ORYX_BUILD": "True"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Web/sites', 'backEnd-TEST')]"
              ]
            }
          ],
          "outputs": {
            "SERVICE_API_IDENTITY_PRINCIPAL_ID": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Web/sites', 'frontEnd-TEST'), '2021-02-01', 'full').identity.principalId]"
            }
          }
        }
      },
      "dependsOn": [
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', 'rg-TEST')]"
      ]
    }
  ],
  "outputs": {
    "SERVICE_API_IDENTITY_PRINCIPAL_ID": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, 'rg-TEST'), 'Microsoft.Resources/deployments', 'rg_TEST'), '2022-09-01').outputs.SERVICE_API_IDENTITY_PRINCIPAL_ID.value]"
    }
  }
}