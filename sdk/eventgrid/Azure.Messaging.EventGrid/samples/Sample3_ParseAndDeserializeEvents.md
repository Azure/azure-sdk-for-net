# Deserializing Events Delivered to Event Handlers

This sample will demonstrate how to deserialize events that have been delivered to event handlers. There are several different Azure services that act as [event handlers](https://docs.microsoft.com/en-us/azure/event-grid/event-handlers) - in this sample, events of the Event Grid schema have been routed to a Service Bus queue. Regardless of the event handler, events are always sent as UTF-8 encoded JSON.

Handling events will be different based on which schema the event was delivered as. However, the general pattern will remain the same:
- Parse events from JSON into individual events. Based on the event schema (Event Grid or CloudEvents 1.0), you can now access basic information about the event on the envelope (properties that are present for all events, like event time and type).
- Deserialize the event data. Given an `EventGridEvent` or `CloudEvent`, the user can attempt to access the event payload, or data, by deserializing to a specific type. You can supply a custom serializer at this point to correctly decode the data.

## Parse Events from JSON payload

### Using `EventGridEvent`
Using the Service Bus SDK, we receive messages from the Service Bus queue and then parse the JSON payload into list of events.
Note that `CloudEvent` has a similar `Parse` method.
```csharp Snippet:ParseJson
// Event Grid delivers a single event per message when routing events to a Service Bus Queue or Topic
// So egEvents should only have one event
EventGridEvent egEvent = EventGridEvent.Parse(receivedMessage.Body)[0];

// Another approach for parsing an event from a Service Bus message is to call `ToEventGridEvent` on the message body
EventGridEvent egEventExtra = receivedMessage.Body.ToEventGridEvent();
```

## Deserialize Event Data
From here, one can access the event data by deserializing to a specific type using `GetData<T>()`, passing in a custom serializer if necessary. Calling `GetData()` will either return a deserialized system event (an event generated by an Azure service), or the event data wrapped in `BinaryData`, which represents the serialized JSON event data as bytes.

### Using `GetData()`
If expecting mostly system events, it may be cleaner to switch on object `GetData()` and use pattern matching to deserialize events. In the case where there are unrecognized event types, one can use the returned `BinaryData` to deserialize the custom event data.

```csharp Snippet:DeserializePayloadUsingNonGenericGetData
// If the event is a system event, GetData() should return the correct system event type
switch (egEvent.GetData())
{
    case SubscriptionValidationEventData subscriptionValidated:
        Console.WriteLine(subscriptionValidated.ValidationCode);
        break;
    case StorageBlobCreatedEventData blobCreated:
        Console.WriteLine(blobCreated.BlobType);
        break;
    case BinaryData unknownType:
        // An unrecognized event type - GetData() returns BinaryData with the serialized JSON payload
        // You can use BinaryData methods to deserialize the payload
        if (egEvent.EventType == "MyApp.Models.CustomEventType")
        {
            TestPayload deserializedEventData = await unknownType.ToObject<TestPayload>();
            Console.WriteLine(deserializedEventData.Name);
        }
        break;
}
```
### Using `GetData<T>()`
Below is an example calling `GetData<T>()`. In order to deserialize to the correct type, the `EventType` property helps distinguish between different events. Custom event data should be deserialized using the generic method `GetData<T>()`. There is also an overload for `GetData<T>()` that accepts a custom `ObjectSerializer` to deserialize the event data.

```csharp Snippet:DeserializePayloadUsingGenericGetData
switch (egEvent.EventType)
{
    case "Contoso.Items.ItemReceived":
        // By default, GetData uses JsonObjectSerializer to deserialize the payload
        ContosoItemReceivedEventData itemReceived = egEvent.GetData<ContosoItemReceivedEventData>();
        Console.WriteLine(itemReceived.ItemSku);
        break;
    case "MyApp.Models.CustomEventType":
        // One can also specify a custom ObjectSerializer as needed to deserialize the payload correctly
        TestPayload testPayload = egEvent.GetData<TestPayload>(myCustomSerializer);
        Console.WriteLine(testPayload.Name);
        break;
    case "Microsoft.EventGrid.SubscriptionValidationEvent":
        SubscriptionValidationEventData subscriptionValidated = egEvent.GetData<SubscriptionValidationEventData>();
        Console.WriteLine(subscriptionValidated.ValidationCode);
        break;
}
```

## Source
To view the full example source, see:
- [Sample2_ParseAndDeserializeEvents.cs](../tests/Samples/Sample1_ParseAndDeserializeEvents.cs)
