// Copyright (c) Microsoft Corporation. All rights reserved.
// Licensed under the MIT License.

// <auto-generated/>

using System.Collections.Generic;
using System.Text.Json;

namespace Azure.AI.Inference.Telemetry
{
    internal class SingleRecordedResponse : AbstractRecordedResponse
    {
        private readonly string[] m_completions;
        /// <summary>
        /// Create the instance of Single recorded response.
        /// </summary>
        /// <param name="response"></param>
        public SingleRecordedResponse(ChatCompletions response) {
            Id = response.Id;
            Model = response.Model;
            PromptTokens = response.Usage.PromptTokens;
            CompletionTokens = response.Usage.CompletionTokens;

            m_completions = new string[response.Choices.Count];
            // Record the event for each response
            int i = 0;
            // For ChatCompletions we do not have single finish reason
            // we will take it from the last chat choice.
            if (response.Choices.Count > 0)
                FinishReason = response.Choices[response.Choices.Count - 1].FinishReason.ToString();
            foreach (ChatChoice choice in response.Choices)
            {
                var messageDict = new Dictionary<string, object>
                {
                    {"content", choice.Message.Content}
                };
                var evt = new Dictionary<string, object> {
                    {"message", messageDict },
                    {"finish_reason", choice.FinishReason.ToString() ?? "" },
                    {"index", choice.Index},
                };
                if (choice.Message.ToolCalls != null && choice.Message.ToolCalls.Count > 0)
                {
                    var calls = new List<Dictionary<string, object>>();
                    foreach (ChatCompletionsFunctionToolCall toolCall in choice.Message.ToolCalls)
                    {
                        calls.Add(JsonSerializer.Deserialize<Dictionary<string, object>>(toolCall.Arguments));
                    }
                    messageDict.Add("tool_calls", calls);
                }
                m_completions[i] = JsonSerializer.Serialize(evt);
                i++;
            }
        }

        public override string[] GetSerializedCompletions() { return m_completions; }
    }
}
