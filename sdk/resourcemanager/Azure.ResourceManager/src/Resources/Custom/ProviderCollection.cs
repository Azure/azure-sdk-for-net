// Copyright (c) Microsoft Corporation. All rights reserved.
// Licensed under the MIT License.

// <auto-generated/>

#nullable disable

using System;
using System.Collections.Generic;
using System.Globalization;
using System.Threading;
using System.Threading.Tasks;
using Azure.Core;
using Azure.Core.Pipeline;
using Azure.ResourceManager.Core;

namespace Azure.ResourceManager.Resources
{
    /// <summary> A class representing collection of Provider and their operations over its parent. </summary>
    [CodeGenSuppress("GetAllAsGenericResources", typeof(string), typeof(string), typeof(int?), typeof(CancellationToken))]
    [CodeGenSuppress("GetAllAsGenericResourcesAsync", typeof(string), typeof(string), typeof(int?), typeof(CancellationToken))]
    public partial class ProviderCollection : ArmCollection, IEnumerable<Provider>, IAsyncEnumerable<Provider>
    {
        /// <summary> Initializes a new instance of the <see cref="ProviderCollection"/> class. </summary>
        /// <param name="parent"> The resource representing the parent resource. </param>
        internal ProviderCollection(ArmResource parent) : this(parent.Client, parent.Id)
        {
        }

        internal ProviderCollection(ArmClient client, ResourceIdentifier id)
            : base(client, id)
        {
            _providerClientDiagnostics = new ClientDiagnostics("Azure.ResourceManager.Resources", Provider.ResourceType.Namespace, DiagnosticOptions);
            Client.TryGetApiVersion(Provider.ResourceType, out string providerApiVersion);
            _providerRestClient = new ProvidersRestOperations(_providerClientDiagnostics, Pipeline, DiagnosticOptions.ApplicationId, BaseUri, providerApiVersion);
#if DEBUG
            ValidateResourceId(Id);
#endif
        }

        [ForwardsClientCalls(true)]
        internal virtual string GetApiVersion(ResourceType resourceType, CancellationToken cancellationToken = default)
        {
            string version;
            Dictionary<string, string> resourceVersions;
            if (!Client.ResourceApiVersionCache.TryGetValue(resourceType.Namespace, out resourceVersions))
            {
                resourceVersions = LoadResourceVersionsFromApi(resourceType.Namespace, cancellationToken);
                Client.ResourceApiVersionCache.TryAdd(resourceType.Namespace, resourceVersions);
            }
            if (!resourceVersions.TryGetValue(resourceType.Type, out version))
            {
                throw new InvalidOperationException($"Invalid resource type {resourceType}");
            }
            return version;
        }

        [ForwardsClientCalls(true)]
        internal virtual async ValueTask<string> GetApiVersionAsync(ResourceType resourceType, CancellationToken cancellationToken = default)
        {
            string version;
            Dictionary<string, string> resourceVersions;
            if (!Client.ResourceApiVersionCache.TryGetValue(resourceType.Namespace, out resourceVersions))
            {
                resourceVersions = await LoadResourceVersionsFromApiAsync(resourceType.Namespace, cancellationToken).ConfigureAwait(false);
                Client.ResourceApiVersionCache.TryAdd(resourceType.Namespace, resourceVersions);
            }
            if (!resourceVersions.TryGetValue(resourceType.Type, out version))
            {
                throw new InvalidOperationException($"Invalid resource type {resourceType}");
            }
            return version;
        }

        private Dictionary<string, string> LoadResourceVersionsFromApi(string resourceNamespace, CancellationToken cancellationToken = default)
        {
            Provider results = Get(resourceNamespace, cancellationToken: cancellationToken);
            return GetVersionsFromResult(results);
        }

        private async Task<Dictionary<string, string>> LoadResourceVersionsFromApiAsync(string resourceNamespace, CancellationToken cancellationToken = default)
        {
            Provider results = await GetAsync(resourceNamespace, cancellationToken: cancellationToken).ConfigureAwait(false);
            return GetVersionsFromResult(results);
        }

        private static Dictionary<string, string> GetVersionsFromResult(Provider results)
        {
            Dictionary<string, string> resourceVersions = new Dictionary<string, string>();
            foreach (var type in results.Data.ResourceTypes)
            {
                resourceVersions[type.ResourceType] = type.ApiVersions[0];
            }
            return resourceVersions;
        }

        internal string GetApiVersionForNamespace(string resourceNamespace, CancellationToken cancellationToken = default)
        {
            string version;
            if (!Client.NamespaceVersionCache.TryGetValue(resourceNamespace, out version))
            {
                Provider results = Get(resourceNamespace, cancellationToken: cancellationToken);
                version = GetMaxVersion(results);
                Client.NamespaceVersionCache.TryAdd(resourceNamespace, version);
            }
            return version;
        }

        internal async ValueTask<string> GetApiVersionForNamespaceAsync(string resourceNamespace, CancellationToken cancellationToken = default)
        {
            string version;
            if (!Client.NamespaceVersionCache.TryGetValue(resourceNamespace, out version))
            {
                Provider results = await GetAsync(resourceNamespace, cancellationToken: cancellationToken).ConfigureAwait(false);
                version = GetMaxVersion(results);
                Client.NamespaceVersionCache.TryAdd(resourceNamespace, version);
            }
            return version;
        }

        private static string GetMaxVersion(Provider results)
        {
            DateTime maxVersion = DateTime.MinValue;
            string maxVersionStr = null;
            foreach (var type in results.Data.ResourceTypes)
            {
                string strVersion = GetDateFromVersion(type.ApiVersions[0]);
                DateTime current = DateTime.Parse(strVersion, CultureInfo.InvariantCulture);
                if (current > maxVersion)
                {
                    maxVersion = current;
                    maxVersionStr = strVersion;
                }
            }
            return maxVersionStr.ToString();
        }

        private static string GetDateFromVersion(string version)
        {
            var span = version.AsSpan();
            int firstDash = span.IndexOf('-');
            var slice = span.Slice(0, firstDash + 1);
            int end = slice.IndexOf('-');
            return span.Slice(0, firstDash + end + 2).ToString();
        }
    }
}
