// Copyright (c) Microsoft Corporation. All rights reserved.
// Licensed under the MIT License.

// <auto-generated/>

#nullable disable

using System;
using System.Collections.Generic;
using System.Globalization;
using System.Threading;
using System.Threading.Tasks;
using Azure.Core;
using Azure.Core.Pipeline;
using Azure.ResourceManager.Core;

namespace Azure.ResourceManager.Resources
{
    /// <summary> A class representing collection of Provider and their operations over its parent. </summary>
    [CodeGenSuppress("ProviderCollection", typeof(ArmResource))]
    [CodeGenSuppress("GetAllAsGenericResources", typeof(string), typeof(string), typeof(int?), typeof(CancellationToken))]
    [CodeGenSuppress("GetAllAsGenericResourcesAsync", typeof(string), typeof(string), typeof(int?), typeof(CancellationToken))]
    public partial class ProviderCollection : ArmCollection, IEnumerable<Provider>, IAsyncEnumerable<Provider>
    {
        /// <summary>
        /// Initializes a new instance of the <see cref="ProviderCollection"/> class.
        /// </summary>
        /// <param name="parent"> The client context to use. </param>
        internal ProviderCollection(Subscription parent)
            : base(parent)
        {
            _clientDiagnostics = new ClientDiagnostics(ClientOptions);
            ClientOptions.TryGetApiVersion(Provider.ResourceType, out var apiVersion);
            _providersRestClient = new ProvidersRestOperations(_clientDiagnostics, Pipeline, ClientOptions, BaseUri, apiVersion);
#if DEBUG
            ValidateResourceId(Id);
#endif
        }

        internal ProviderCollection(ArmResource operations, ResourceIdentifier id)
            : base(new ClientContext(operations.ClientOptions, operations.Credential, operations.BaseUri, operations.Pipeline), id)
        {
            _clientDiagnostics = new ClientDiagnostics(ClientOptions);
            ClientOptions.TryGetApiVersion(Provider.ResourceType, out var apiVersion);
            _providersRestClient = new ProvidersRestOperations(_clientDiagnostics, Pipeline, ClientOptions, BaseUri, apiVersion);
#if DEBUG
            ValidateResourceId(Id);
#endif
        }

        /// <summary>
        /// Gets the parent resource of this resource.
        /// </summary>
        protected new Subscription Parent { get {return base.Parent as Subscription;} }

        internal string TryGetApiVersion(ResourceType resourceType, CancellationToken cancellationToken = default)
        {
            string version;
            Dictionary<string, string> resourceVersions;
            if (!ClientOptions.ResourceApiVersions.TryGetValue(resourceType.Namespace, out resourceVersions))
            {
                resourceVersions = LoadResourceVersionsFromApi(resourceType.Namespace, cancellationToken);
                ClientOptions.ResourceApiVersions.TryAdd(resourceType.Namespace, resourceVersions);
            }
            if (!resourceVersions.TryGetValue(resourceType.Type, out version))
            {
                throw new InvalidOperationException($"Invalid resource type {resourceType}");
            }
            return version;
        }

        internal async ValueTask<string> TryGetApiVersionAsync(ResourceType resourceType, CancellationToken cancellationToken = default)
        {
            string version;
            Dictionary<string, string> resourceVersions;
            if (!ClientOptions.ResourceApiVersions.TryGetValue(resourceType.Namespace, out resourceVersions))
            {
                resourceVersions = await LoadResourceVersionsFromApiAsync(resourceType.Namespace, cancellationToken).ConfigureAwait(false);
                ClientOptions.ResourceApiVersions.TryAdd(resourceType.Namespace, resourceVersions);
            }
            if (!resourceVersions.TryGetValue(resourceType.Type, out version))
            {
                throw new InvalidOperationException($"Invalid resource type {resourceType}");
            }
            return version;
        }

        private Dictionary<string, string> LoadResourceVersionsFromApi(string resourceNamespace, CancellationToken cancellationToken = default)
        {
            Provider results = Get(resourceNamespace, cancellationToken: cancellationToken);
            return GetVersionsFromResult(results);
        }

        private async Task<Dictionary<string, string>> LoadResourceVersionsFromApiAsync(string resourceNamespace, CancellationToken cancellationToken = default)
        {
            Provider results = await GetAsync(resourceNamespace, cancellationToken: cancellationToken).ConfigureAwait(false);
            return GetVersionsFromResult(results);
        }

        private static Dictionary<string, string> GetVersionsFromResult(Provider results)
        {
            Dictionary<string, string> resourceVersions = new Dictionary<string, string>();
            foreach (var type in results.Data.ResourceTypes)
            {
                resourceVersions[type.ResourceType] = type.ApiVersions[0];
            }
            return resourceVersions;
        }

        internal string GetApiVersionForNamespace(string resourceNamespace, CancellationToken cancellationToken = default)
        {
            string version;
            if (!ClientOptions.NamespaceVersions.TryGetValue(resourceNamespace, out version))
            {
                Provider results = Get(resourceNamespace, cancellationToken: cancellationToken);
                version = GetMaxVersion(results);
                ClientOptions.NamespaceVersions.TryAdd(resourceNamespace, version);
            }
            return version;
        }

        internal async ValueTask<string> GetApiVersionForNamespaceAsync(string resourceNamespace, CancellationToken cancellationToken = default)
        {
            string version;
            if (!ClientOptions.NamespaceVersions.TryGetValue(resourceNamespace, out version))
            {
                Provider results = await GetAsync(resourceNamespace, cancellationToken: cancellationToken).ConfigureAwait(false);
                version = GetMaxVersion(results);
                ClientOptions.NamespaceVersions.TryAdd(resourceNamespace, version);
            }
            return version;
        }

        private static string GetMaxVersion(Provider results)
        {
            DateTime maxVersion = DateTime.MinValue;
            string maxVersionStr = null;
            foreach (var type in results.Data.ResourceTypes)
            {
                string strVersion = GetDateFromVersion(type.ApiVersions[0]);
                DateTime current = DateTime.Parse(strVersion, CultureInfo.InvariantCulture);
                if (current > maxVersion)
                {
                    maxVersion = current;
                    maxVersionStr = strVersion;
                }
            }
            return maxVersionStr.ToString();
        }

        private static string GetDateFromVersion(string version)
        {
            var span = version.AsSpan();
            int firstDash = span.IndexOf('-');
            var slice = span.Slice(0, firstDash + 1);
            int end = slice.IndexOf('-');
            return span.Slice(0, firstDash + end + 2).ToString();
        }
    }
}
