// Copyright (c) Microsoft Corporation. All rights reserved.
// Licensed under the MIT License.

using System;
using System.Threading.Tasks;
using Azure;
using Azure.Core;
using Azure.Core.TestFramework;
using Azure.ResourceManager;
using Azure.ResourceManager.Models;
using Azure.ResourceManager.Resources;
using Azure.ResourceManager.PlanetaryComputer;
using Azure.ResourceManager.PlanetaryComputer.Models;
using NUnit.Framework;

namespace Azure.ResourceManager.PlanetaryComputer.Tests
{
    [TestFixture(true)]
    public class GeoCatalogCollectionTests : PlanetaryComputerManagementTestBase
    {
        // Add ExistingGeoCatalogName if you have a catalog to test against. This is for testing the GetGeoCatalog method.
        private const string ExistingGeoCatalogName = "";
        // Set the ResourceGroupName and Region to match your Azure environment.
        // Ensure the resource group exists in your subscription.
        private const string ResourceGroupName = "shakrao-test";
        private const string Region = "uksouth";

        public GeoCatalogCollectionTests(bool isAsync)
            : base(isAsync) // <-- Forces Record mode explicitly
        {
        }

        [Test]
        [RecordedTest]
        public async Task ListGeoCatalogsInResourceGroup()
        {
            SubscriptionResource subscription = await Client.GetDefaultSubscriptionAsync();
            ResourceGroupResource rg = await subscription.GetResourceGroups().GetAsync(ResourceGroupName);
            GeoCatalogCollection collection = rg.GetGeoCatalogs();

            int count = 0;
            await foreach (GeoCatalogResource item in collection.GetAllAsync())
            {
                TestContext.WriteLine($"GeoCatalog: {item.Data.Name}");
                count++;
            }

            Assert.GreaterOrEqual(count, 0);
        }

        [Test]
        [RecordedTest]
        public async Task GetGeoCatalog()
        {
            if (string.IsNullOrEmpty(ExistingGeoCatalogName))
            {
                Assert.Inconclusive("No existing GeoCatalog name provided.");
                return;
            }

            GeoCatalogCollection collection = await GetGeoCatalogCollectionAsync();
            GeoCatalogResource catalog = await collection.GetAsync(ExistingGeoCatalogName);

            Assert.AreEqual(ExistingGeoCatalogName, catalog.Data.Name);
            Assert.AreEqual(Region.ToLowerInvariant(), catalog.Data.Location.ToString().ToLowerInvariant());
            TestContext.WriteLine($"Catalog URI: {catalog.Data.Properties.CatalogUri}");
        }

        [Test]
        [RecordedTest]
        public async Task CreateGeoCatalog()
        {
            string catalogName = Recording.GenerateAssetName("testcatalog-");
            GeoCatalogCollection collection = await GetGeoCatalogCollectionAsync();
            GeoCatalogData data = new GeoCatalogData(new AzureLocation(Region))
            {
                Identity = new ManagedServiceIdentity(Azure.ResourceManager.Models.ManagedServiceIdentityType.UserAssigned)
                {
                    UserAssignedIdentities =
                    {
                        [new ResourceIdentifier($"/subscriptions/ac9a1867-7476-4346-bf8b-968370fe212c/resourceGroups/msi-test/providers/Microsoft.ManagedIdentity/userAssignedIdentities/msi-test-uk-1")] = new UserAssignedIdentity()
                    }
                },
                Properties = new GeoCatalogProperties
                {
                    Tier = CatalogTier.Basic,
                    AutoGeneratedDomainNameLabelScope = AutoGeneratedDomainNameLabelScope.TenantReuse
                },
                Tags = { ["env"] = "test" }
            };

            ArmOperation<GeoCatalogResource> operation = await collection.CreateOrUpdateAsync(WaitUntil.Completed, catalogName, data);
            GeoCatalogResource result = operation.Value;

            Assert.AreEqual(catalogName, result.Data.Name);
            Assert.AreEqual(CatalogTier.Basic, result.Data.Properties.Tier);
            TestContext.WriteLine($"Created GeoCatalog: {result.Id}");
        }

        [Test]
        [RecordedTest]
        public async Task UpdateGeoCatalog()
        {
            string catalogName = Recording.GenerateAssetName("testcatalog-");
            GeoCatalogCollection collection = await GetGeoCatalogCollectionAsync();

            GeoCatalogData data = new GeoCatalogData(new AzureLocation(Region))
            {
                Properties = new GeoCatalogProperties
                {
                    Tier = CatalogTier.Basic,
                    AutoGeneratedDomainNameLabelScope = AutoGeneratedDomainNameLabelScope.TenantReuse
                },
                Tags = { ["env"] = "initial" }
            };

            ArmOperation<GeoCatalogResource> createOp = await collection.CreateOrUpdateAsync(WaitUntil.Completed, catalogName, data);
            GeoCatalogResource resource = createOp.Value;

            resource.Data.Tags["env"] = "updated";
            ArmOperation<GeoCatalogResource> updateOp = await collection.CreateOrUpdateAsync(WaitUntil.Completed, catalogName, resource.Data);
            GeoCatalogResource updated = updateOp.Value;

            Assert.AreEqual("updated", updated.Data.Tags["env"]);
            TestContext.WriteLine($"Updated GeoCatalog: {updated.Id}");
        }

        [Test]
        [RecordedTest]
        public async Task DeleteGeoCatalog()
        {
            string catalogName = Recording.GenerateAssetName("testcatalog-");
            GeoCatalogCollection collection = await GetGeoCatalogCollectionAsync();

            GeoCatalogData data = new GeoCatalogData(new AzureLocation(Region))
            {
                Properties = new GeoCatalogProperties
                {
                    Tier = CatalogTier.Basic,
                    AutoGeneratedDomainNameLabelScope = AutoGeneratedDomainNameLabelScope.TenantReuse
                },
                Tags = { ["env"] = "delete" }
            };

            ArmOperation<GeoCatalogResource> createOp = await collection.CreateOrUpdateAsync(WaitUntil.Completed, catalogName, data);
            GeoCatalogResource resource = createOp.Value;

            ArmOperation deleteOp = await resource.DeleteAsync(WaitUntil.Completed);
            Assert.IsTrue(deleteOp.HasCompleted);

            bool exists = await collection.ExistsAsync(catalogName);
            Assert.IsFalse(exists);
            TestContext.WriteLine($"Deleted GeoCatalog: {catalogName}");
        }

        [Test]
        [RecordedTest]
        public async Task ListGeoCatalogsBySubscription()
        {
            SubscriptionResource subscription = await Client.GetDefaultSubscriptionAsync();
            AsyncPageable<GeoCatalogResource> catalogs = subscription.GetGeoCatalogsAsync();

            int count = 0;
            await foreach (GeoCatalogResource item in catalogs)
            {
                TestContext.WriteLine($"[Subscription List] GeoCatalog: {item.Data.Name}");
                count++;
            }
            Assert.GreaterOrEqual(count, 0);
        }
        [Test]
        [RecordedTest]
        public async Task CreateUpdateDeleteGeoCatalog()
        {
            Console.WriteLine($"[MODE] Test is running in: {TestEnvironment.Mode}");

            string catalogName = Recording.GenerateAssetName("testcatalog-");
            GeoCatalogCollection collection = await GetGeoCatalogCollectionAsync();

            // Step 1: Create
            GeoCatalogData data = new GeoCatalogData(new AzureLocation(Region))
            {
                Properties = new GeoCatalogProperties
                {
                    Tier = CatalogTier.Basic,
                    AutoGeneratedDomainNameLabelScope = AutoGeneratedDomainNameLabelScope.TenantReuse
                },
                Tags = { ["env"] = "initial" }
            };

            ArmOperation<GeoCatalogResource> createOp = await collection.CreateOrUpdateAsync(WaitUntil.Completed, catalogName, data);
            GeoCatalogResource resource = createOp.Value;

            Assert.AreEqual("initial", resource.Data.Tags["env"]);
            TestContext.WriteLine($"‚úÖ Created GeoCatalog: {resource.Id}");

            // Step 2: Update
            resource.Data.Tags["env"] = "updated";
            ArmOperation<GeoCatalogResource> updateOp = await collection.CreateOrUpdateAsync(WaitUntil.Completed, catalogName, resource.Data);
            GeoCatalogResource updated = updateOp.Value;

            Assert.AreEqual("updated", updated.Data.Tags["env"]);
            TestContext.WriteLine($"üîÑ Updated GeoCatalog: {updated.Id}");

            // Step 3: Delete
            ArmOperation deleteOp = await updated.DeleteAsync(WaitUntil.Completed);
            Assert.IsTrue(deleteOp.HasCompleted);

            bool exists = await collection.ExistsAsync(catalogName);
            Assert.IsFalse(exists);
            TestContext.WriteLine($"‚ùå Deleted GeoCatalog: {catalogName}");
        }

        private async Task<GeoCatalogCollection> GetGeoCatalogCollectionAsync()
        {
            SubscriptionResource subscription = await Client.GetDefaultSubscriptionAsync();
            ResourceGroupResource rg = await subscription.GetResourceGroups().GetAsync(ResourceGroupName);
            return rg.GetGeoCatalogs();
        }
    }
}
