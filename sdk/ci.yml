name: CI Pipeline

on:
  push:
    branches:
      - main
      - feature/*
      - hotfix/*
      - release/*
  pull_request:
    branches:
      - main
      - feature/*
      - hotfix/*
      - release/*

jobs:
  format:
    name: Code Formatting
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Set up .NET
        uses: actions/setup-dotnet@v1
        with:
          dotnet-version: '6.0.x'

      - name: Install dotnet-format
        run: dotnet tool install -g dotnet-format

      - name: Run dotnet-format
        run: dotnet format --check

  lint:
    name: Linting
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Set up .NET
        uses: actions/setup-dotnet@v1
        with:
          dotnet-version: '6.0.x'

      - name: Install dotnet-format
        run: dotnet tool install -g dotnet-format

      - name: Run dotnet-format
        run: dotnet format --check

  build:
    name: Build and Test
    runs-on: ubuntu-latest
    strategy:
      matrix:
        sdk:
          - appconfiguration
          - communication
          - keyvault
          - servicebus
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Set up .NET
        uses: actions/setup-dotnet@v1
        with:
          dotnet-version: '6.0.x'

      - name: Build
        run: dotnet build sdk/${{ matrix.sdk }}/*.csproj

      - name: Test
        run: dotnet test sdk/${{ matrix.sdk }}/*.csproj

  update-dependencies:
    name: Update Dependencies
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Set up .NET
        uses: actions/setup-dotnet@v1
        with:
          dotnet-version: '6.0.x'

      - name: Install NuKeeper
        run: dotnet tool install -g NuKeeper

      - name: Run NuKeeper
        run: nukeeper update --useprerelease
