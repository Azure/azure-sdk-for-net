parameters:
  - name: ScriptDirectory
    type: string
    default: 'eng/common/scripts'
  - name: AgentImage
    type: string

steps:
  - task: PowerShell@2
    displayName: Verify agent OS
    inputs:
      pwsh: true
      workingDirectory: $(System.DefaultWorkingDirectory)
      filePath: ${{ parameters.ScriptDirectory }}/Verify-AgentOS.ps1
      arguments: >
        -AgentImage "${{ parameters.AgentImage }}"

  # Print agent metadata (https://docs.microsoft.com/en-us/azure/virtual-machines/windows/instance-metadata-service)
  - pwsh: Invoke-RestMethod -Headers @{"Metadata"="true"} -Method GET -Proxy $Null -Uri "http://169.254.169.254/metadata/instance?api-version=2020-09-01" | ConvertTo-Json -Depth 64

  - template: /eng/common/pipelines/templates/steps/bypass-local-dns.yml
