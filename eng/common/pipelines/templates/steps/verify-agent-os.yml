parameters:
  - name: ScriptDirectory
    type: string
    default: 'eng/common/scripts'
  - name: AgentImage
    type: string

steps:
  - task: PowerShell@2
    displayName: Verify agent OS
    inputs:
      pwsh: true
      workingDirectory: $(System.DefaultWorkingDirectory)
      filePath: ${{ parameters.ScriptDirectory }}/Verify-AgentOS.ps1
      arguments: >
        -AgentImage "${{ parameters.AgentImage }}"

  # Enable FIPS
  - powershell: |
      New-Object -TypeName System.Security.Cryptography.MD5CryptoServiceProvider
      reg add HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Lsa\FipsAlgorithmPolicy /v Enabled /t REG_DWORD /d 1 /f
    displayName: Enable FIPS
    condition: |
      and(
        succeededOrFailed(),
        contains(variables['OSVmImage'], 'windows'),
        eq(variables['Container'], '')
      )

  # Verify FIPS is enabled (command should throw exception)
  - powershell: |
      New-Object -TypeName System.Security.Cryptography.MD5CryptoServiceProvider
    displayName: Verify FIPS is enabled
    ignoreLASTEXITCODE: 'true'
    condition: |
      and(
        succeededOrFailed(),
        contains(variables['OSVmImage'], 'windows'),
        eq(variables['Container'], '')
      )

  - template: /eng/common/pipelines/templates/steps/bypass-local-dns.yml
