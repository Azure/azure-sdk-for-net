# Checks spelling of files that changed between the current state of the repo
# and some ref (branch, tag, etc.) or commit hash. Only runs on PRs.
# ContinueOnError - true: Pipeline warns on spelling error 
#                   false: Pipeline fails on spelling error
# TargetRef       - Target ref (e.g. master) to compare to create file change
#                   list
# CspellConfigPath - Path to cspell.json config location

parameters:
  ContinueOnError: true
  TargetRef: $(System.PullRequest.TargetBranch)
  CspellConfigPath: ./.vscode/cspell.json

steps:
  - ${{ if eq(variables['Build.Reason'], 'PullRequest') }}:
    # Devops uses a git config that changes ref names. 
    # For example: refs/heads/master -> refs/remotes/origin/master
    # Set in: fetch = +refs/heads/*:refs/remotes/origin/*
    # Rather than try to convert ${{ parameters.TargetRef }} this
    # explicitly fetches the ref with a specific name that will not collide with
    # the other refs fetched
    - task: PowerShell@2
      displayName: Fetch ref for ${{ parameters.TargetRef }}
      inputs:
        pwsh: true
        targetType: inline
        script: git fetch origin ${{ parameters.TargetRef }}:refs/spellcheck/baseref

    - task: PowerShell@2
      displayName: Check spelling (cspell)
      continueOnError: ${{ parameters.ContinueOnError }}
      inputs: 
        targetType: filePath
        filePath: eng/common/scripts/Test-Spelling.ps1
        arguments: >- 
          -TargetRef refs/spellcheck/baseref
          -CspellConfigPath ${{ parameters.CspellConfigPath }}
        pwsh: true
