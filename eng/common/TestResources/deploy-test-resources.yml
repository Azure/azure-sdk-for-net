# Deploys resources to a cloud type specified by the variable (not parameter)
# 'CloudType'. Use this as part of a matrix to deploy resources to a particular
# cloud instance.

parameters:
  ServiceDirectory: not-set
  AdditionalParameters: ''
  DeleteAfterHours: 24
  Location: 'westus2'

steps:
  # New-TestResources command requires Az module
  - pwsh: Install-Module -Name Az -Scope CurrentUser -AllowClobber -Force -Verbose
    displayName: Install Azure PowerShell module

  - pwsh: >
      eng/common/TestResources/New-TestResources.ps1
      -BaseName 'Generated'
      -ServiceDirectory '${{ parameters.ServiceDirectory }}'
      -TenantId '$(aad-azure-sdk-test-tenant-id)'
      -TestApplicationId '$(aad-azure-sdk-test-client-id)'
      -TestApplicationSecret '$(aad-azure-sdk-test-client-secret)'
      -ProvisionerApplicationId '$(aad-azure-sdk-test-client-id)'
      -ProvisionerApplicationSecret '$(aad-azure-sdk-test-client-secret)'
      -AdditionalParameters ${{ parameters.AdditionalParameters }}
      -DeleteAfterHours ${{ parameters.DeleteAfterHours }}
      -Location '${{ parameters.Location }}'
      -Environment 'AzureCloud'
      -CI
      -Force
      -Verbose
    displayName: Deploy test resources (public)
    condition: and(succeeded(), eq(variables['CloudType'], 'public'))

  - pwsh: >
      eng/common/TestResources/New-TestResources.ps1
      -BaseName 'Generated'
      -ServiceDirectory '${{ parameters.ServiceDirectory }}'
      -TenantId '$(aad-azure-sdk-test-tenant-id-gov)'
      -TestApplicationId '$(aad-azure-sdk-test-client-id-gov)'
      -TestApplicationSecret '$(aad-azure-sdk-test-client-secret-gov)'
      -ProvisionerApplicationId '$(aad-azure-sdk-test-client-id-gov)'
      -ProvisionerApplicationSecret '$(aad-azure-sdk-test-client-secret-gov)'
      -AdditionalParameters ${{ parameters.AdditionalParameters }}
      -DeleteAfterHours ${{ parameters.DeleteAfterHours }}
      -Location '${{ parameters.Location }}'
      -Environment 'AzureUSGovernment'
      -CI
      -Force
      -Verbose
    displayName: Deploy test resources (gov)
    condition: and(succeeded(), eq(variables['CloudType'], 'gov'))

  - pwsh: >
      eng/common/TestResources/New-TestResources.ps1
      -BaseName 'Generated'
      -ServiceDirectory '${{ parameters.ServiceDirectory }}'
      -TenantId '$(aad-azure-sdk-test-tenant-id-cn)'
      -TestApplicationId '$(aad-azure-sdk-test-client-id-cn)'
      -TestApplicationSecret '$(aad-azure-sdk-test-client-secret-cn)'
      -ProvisionerApplicationId '$(aad-azure-sdk-test-client-id-cn)'
      -ProvisionerApplicationSecret '$(aad-azure-sdk-test-client-secret-cn)'
      -AdditionalParameters ${{ parameters.AdditionalParameters }}
      -DeleteAfterHours ${{ parameters.DeleteAfterHours }}
      -Location '${{ parameters.Location }}'
      -Environment 'AzureChinaCloud'
      -CI
      -Force
      -Verbose
    displayName: Deploy test resources (cn)
    condition: and(succeeded(), eq(variables['CloudType'], 'cn'))