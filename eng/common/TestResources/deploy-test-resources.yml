parameters:
  ServiceDirectory: not-set
  ArmTemplateParameters: '$subscriptionConfiguration.ArmTemplateParameters'
  PlatformArmTemplateParameters: ''
  DeleteAfterHours: 24
  Location: ''
  SubscriptionConfiguration: $(sub-config-azure-cloud-test-resources)
  Platform: ''

# SubscriptionConfiguration will be splat into the parameters of the test
# resources script. It should be JSON in the form:
# {
#   "SubscriptionId": "<subscription id>",
#   "TenantId": "<tenant id>",
#   "TestApplicationId": "<test app id>",
#   "TestApplicationSecret": "<test app secret>",
#   "ProvisionerApplicationId": "<provisioner app id>",
#   "ProvisionerApplicationSecret": "<provisioner app secret>",
#   "Environment": "AzureCloud | AzureGov | AzureChina | <other environment>"
#   "EnvironmentVariables": {
#       "SERVICE_MANAGEMENT_URL": "<service management url>",
#       "STORAGE_ENDPOINT_SUFFIX": "<storage endpoint suffix>",
#       "RESOURCE_MANAGER_URL": "<resource manager url>",
#       "SEARCH_ENDPOINT_SUFFIX": "<search endpoint suffix>",
#       "COSMOS_TABLES_ENDPOINT_SUFFIX": "<cosmos tables endpoint suffix>"
#   },
#   "ArmTemplateParameters": {
#       "keyVaultDomainSuffix": "<keyVaultDomainSuffix>",
#       "storageEndpointSuffix": "<storageEndpointSuffix>",
#       "endpointSuffix": "<endpointSuffix>",
#       "azureAuthorityHost": "<azureAuthorityHost>",
#       "keyVaultEndpointSuffix": "<keyVaultEndpointSuffix>"
#   }
# }


steps:
  - template: /eng/common/TestResources/setup-az-modules.yml

  - pwsh: |
      eng/common/TestResources/Import-AzModules.ps1

      $subscriptionConfiguration = @'
        ${{ parameters.SubscriptionConfiguration }}
      '@ | ConvertFrom-Json -AsHashtable;

      # Support legacy ArmTemplateParameters passed in directly as a hashmap, otherwise default to subscriptionConfiguration JSON.
      #   Example legacy input: @{ 'param1' = 'foo' ; 'param2' = 'bar' }
      $subscriptionConfiguration.ArmTemplateParameters = ${{ parameters.ArmTemplateParameters }} ? ${{ parameters.ArmTemplateParameters }} : @{}

      # Support additional sdk pipeline and/or platform specific arm template parameters:
      #   EnableHsm:
      #     Value: true
      #     Platforms:
      #       - Linux_NetCore_Keyring
      #   TestGlobalParam:
      #     Value: global foo
      # For duplicate keys, prefer the template/script parameter.
      $platformArmTemplateParameters = @'
        ${{ parameters.PlatformArmTemplateParameters }}
      '@ | ConvertFrom-Json -AsHashtable;

      if ($platformArmTemplateParameters) {
        foreach ($p in $platformArmTemplateParameters.GetEnumerator()) {
          if (!$p.Value.Platforms -or '${{ parameters.Platform }}' -in $p.Value.Platforms) {
            $subscriptionConfiguration.ArmTemplateParameters[$p.Name] = $p.Value.Value
          }
        }
      }

      eng/common/TestResources/New-TestResources.ps1 `
        -BaseName 'Generated' `
        -ServiceDirectory '${{ parameters.ServiceDirectory }}' `
        -Location '${{ parameters.Location }}' `
        -DeleteAfterHours '${{ parameters.DeleteAfterHours }}' `
        @subscriptionConfiguration `
        -CI `
        -Force `
        -Verbose | Out-Null
    displayName: Deploy test resources
