parameters:
  - name: SubscriptionConfiguration
    type: string
    default: $(sub-config-azure-cloud-test-resources)
  - name: SubscriptionConfigurations
    type: object
    default: null
  # EnvVars is used to help diagnose variable conflict issues early
  - name: EnvVars
    type: object
    default: null
  - name: SubscriptionConfigurationFilePaths
    type: object
    default: null

steps:
  - ${{ if parameters.SubscriptionConfiguration }}:
    - pwsh: |
        $config = @'
          ${{ parameters.SubscriptionConfiguration }}
        '@ | ConvertFrom-Json -AsHashtable

        . ./eng/common/TestResources/SubConfig-Helpers.ps1
        SetSubscriptionConfiguration $config

        Write-Host ($finalConfig | ConvertTo-Json)
        $serialized = $finalConfig | ConvertTo-Json -Compress
        Write-Host "##vso[task.setvariable variable=SubscriptionConfiguration;]$serialized"
      displayName: Initialize SubscriptionConfiguration variable
      ${{ if parameters.EnvVars }}:
        env: ${{ parameters.EnvVars }}

  - ${{ if parameters.SubscriptionConfigurations }}:
    - pwsh: |
        Write-Host "##vso[task.setvariable variable=SubscriptionConfiguration;]{}"
      displayName: Initialize SubscriptionConfiguration variable for merging
      condition: eq(variables['SubscriptionConfiguration'], '')

    - ${{ each config in parameters.SubscriptionConfigurations }}:
      - pwsh: |
          $configBase = @'
            $(SubscriptionConfiguration)
          '@ | ConvertFrom-Json -AsHashtable
          $config = @'
            ${{ config }}
          '@ | ConvertFrom-Json -AsHashtable

          . ./eng/common/TestResources/SubConfig-Helpers.ps1
          UpdateSubscriptionConfiguration $configBase $config

        displayName: Merge Test Resource Configurations
        ${{ if parameters.EnvVars }}:
          env: ${{ parameters.EnvVars }}

  - ${{ if parameters.SubscriptionConfigurationFilePaths }}:
    - pwsh: |
        . ./eng/common/TestResources/SubConfig-Helpers.ps1
        $configBase = @{}
        if ('$(SubscriptionConfiguration)'.Trim() -ne '') {
          # Tabbing of this sort is required for the here-string to work
          $configBase = @'
            $(SubscriptionConfiguration)
        '@ | ConvertFrom-Json -AsHashtable
        }

        $configFiles = @'
          ${{ convertToJson(parameters.SubscriptionConfigurationFilePaths) }}
        '@ | ConvertFrom-Json -AsHashtable

        foreach ($file in $configFiles) {
          $config = Get-Content $file | ConvertFrom-Json -AsHashtable
          $configBase = UpdateSubscriptionConfiguration $configBase $config -devOpsOutput $false
        }

        $serialized = $configBase | ConvertTo-Json -Compress
        Write-Host ($configBase | ConvertTo-Json)
        Write-Host "##vso[task.setvariable variable=SubscriptionConfiguration;]$serialized"
      displayName: Merge in Subscription Configuration File Paths
      ${{ if parameters.EnvVars }}:
        env: ${{ parameters.EnvVars }}