<Project Sdk="Microsoft.NET.Sdk">
  <!--
  This project is used to enforce API compatibility between the GA'ed libraries and the most recent version available on Nuget. The most recent
  version is restored from Nuget via the package references below. The ApiCompatVerification target, specified below, is referenced in the
  eng/Directory.Build.Data.targets file which causes this target to be executed for each csproj that has an ApiCompatVersion set.
  -->
  <PropertyGroup>
    <TargetFramework>netstandard2.0</TargetFramework>
    <RunApiCompatForSrc>true</RunApiCompatForSrc>
  </PropertyGroup>

  <ItemGroup>
    <PackageReference Include="Microsoft.DotNet.ApiCompat" Version="5.0.0-beta.19552.1" />
    <PackageReference Include="$(TargetPackageName)" Version="$(TargetPackageVersion)" />
  </ItemGroup>

  <Target Name="_VerifyTargetPackageInfo">
    <Error Condition="'$(TargetPackageName)' == ''" Text="TargetPackageName is not set!" />
    <Error Condition="'$(TargetPackageVersion)' == ''" Text="TargetPackageVersion is not set!" />
    <Error Condition="'$(TargetOutputPath)' == ''" Text="TargetOutputPath is not set!" />
  </Target>

  <Target Name="ApiCompatVerification"
          DependsOnTargets="_VerifyTargetPackageInfo;
                            Restore;
                            _ResolveResolvedMatchingContract;
                            $(TargetsTriggeredByCompilation)" />

  <Target Name="_ResolveResolvedMatchingContract" DependsOnTargets="ResolveReferences">
    <PropertyGroup>
      <TargetPackageDll Condition="'%(ResolvedCompileFileDefinitions.NuGetPackageId)' == '$(TargetPackageName)'" >%(ResolvedCompileFileDefinitions.Identity)</TargetPackageDll>
    </PropertyGroup>

    <ItemGroup>
      <ResolvedMatchingContract Include="$(TargetPackageDll)" />
      <_DependencyDirectories Include="$(TargetOutputPath)" />
      <ReferencePath Remove="$(TargetPackageDll)" />
    </ItemGroup>
    <Message Text="Running ApiCompatVerification against $(TargetPackageDll) using assemblies from $(TargetOutputPath)" Importance="High" />
  </Target>
</Project>