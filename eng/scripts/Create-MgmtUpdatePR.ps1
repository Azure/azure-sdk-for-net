#Requires -Version 7.0

<#
.SYNOPSIS
Creates a pull request to update http-client-csharp-mgmt package version.

.DESCRIPTION
This script creates a pull request that updates the http-client-csharp-mgmt package
to use the latest version of http-client-csharp that was just published.

.PARAMETER NewVersion
The new version of http-client-csharp that was published.

.PARAMETER BuildNumber
The build number for branch naming and PR description.

.PARAMETER AuthToken
GitHub PAT for creating the pull request.

.PARAMETER RepoRoot
The root directory of the repository. Defaults to the current repository root.
#>

[CmdletBinding()]
param(
    [Parameter(Mandatory = $true)]
    [string] $NewVersion,
    [Parameter(Mandatory = $true)]
    [string] $BuildNumber,
    [Parameter(Mandatory = $true)]
    [string] $AuthToken,
    [string] $RepoRoot = (Get-Item $PSScriptRoot).Parent.Parent.FullName
)

$ErrorActionPreference = 'Stop'
Set-StrictMode -Version 3.0

. "$PSScriptRoot/../common/scripts/common.ps1"
Set-ConsoleEncoding

Write-Host "Creating PR to update http-client-csharp-mgmt to version $NewVersion"

# Set variables for the PR
$branchName = "update-mgmt-http-client-csharp-$BuildNumber"
$prTitle = "Update http-client-csharp-mgmt to use http-client-csharp version $NewVersion"
$prBody = @"
This PR automatically updates the http-client-csharp-mgmt package to use the latest version of http-client-csharp.

**Changes:**
- Updated @azure-typespec/http-client-csharp dependency in eng/packages/http-client-csharp-mgmt/package.json to $NewVersion
- Updated AzureGeneratorVersion in eng/Packages.Data.props to $NewVersion
- Updated package-lock.json with npm install

Generated by http-client-csharp build $BuildNumber.
"@

# Create a new branch
Write-Host "Creating branch: $branchName"
Invoke-LoggedCommand "git checkout -b $branchName"

# Update the packages using our script
Write-Host "Updating package versions"
& "$PSScriptRoot/Update-MgmtPackageVersion.ps1" -NewVersion $NewVersion -RepoRoot $RepoRoot

# Stage all changes
Write-Host "Staging changes"
Invoke-LoggedCommand "git add ."

# Check if there are any changes to commit
$gitStatus = git status --porcelain
if (-not $gitStatus) {
    Write-Host "No changes to commit. The mgmt package is already up to date."
    return
}

# Commit changes
$commitMessage = "Update http-client-csharp-mgmt to use http-client-csharp version $NewVersion"
Write-Host "Committing changes: $commitMessage"
Invoke-LoggedCommand "git commit -m `"$commitMessage`""

# Push the branch
Write-Host "Pushing branch: $branchName"
Invoke-LoggedCommand "git push origin $branchName"

# Create the pull request
Write-Host "Creating pull request"
& "$PSScriptRoot/../common/scripts/Submit-PullRequest.ps1" `
    -RepoOwner "Azure" `
    -RepoName "azure-sdk-for-net" `
    -BaseBranch "main" `
    -PROwner "Azure" `
    -PRBranch $branchName `
    -AuthToken $AuthToken `
    -PRTitle $prTitle `
    -PRBody $prBody `
    -OpenAsDraft $false

Write-Host "Successfully created PR to update http-client-csharp-mgmt to version $NewVersion"