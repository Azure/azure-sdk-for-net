variables:
  - template: ./templates/variables/globals.yml

jobs:
  - job: SmokeTest

    strategy:
      matrix:
        Linux (Public):
          OSName: "Linux"
          OSVmImage: "ubuntu-16.04"
          TestTargetFramework: netcoreapp2.1
          CloudType: public
          AdditionalParameters: $(publicAdditionalParameters)
          Location: $(publicLocation)
        Windows_NetCoreApp (Public):
          OSName: "Windows"
          OSVmImage: "windows-2019"
          TestTargetFramework: netcoreapp2.1
          CloudType: public
          AdditionalParameters: $(publicAdditionalParameters)
          Location: $(publicLocation)
        Windows_NetFramework (Public):
          OSName: "Windows"
          OSVmImage: "windows-2019"
          TestTargetFramework: net461
          CloudType: public
          AdditionalParameters: $(publicAdditionalParameters)
          Location: $(publicLocation)
        MacOs (Public):
          OSName: "MacOS"
          OSVmImage: "macOS-10.15"
          TestTargetFramework: netcoreapp2.1
          CloudType: public
          AdditionalParameters: $(publicAdditionalParameters)
          Location: $(publicLocation)
        Windows_NetCoreApp (Gov):
          OSName: "Windows"
          OSVmImage: "windows-2019"
          TestTargetFramework: netcoreapp2.1
          CloudType: gov
          AdditionalParameters: $(govAdditionalParameters)
          Location: $(govLocation)
        Windows_NetFramework (Gov):
          OSName: "Windows"
          OSVmImage: "windows-2019"
          TestTargetFramework: net461
          CloudType: gov
          AdditionalParameters: $(govAdditionalParameters)
          Location: $(govLocation)
        Windows_NetCoreApp (China):
          OSName: "Windows"
          OSVmImage: "windows-2019"
          TestTargetFramework: netcoreapp2.1
          CloudType: cn
          AdditionalParameters: $(cnAdditionalParameters)
          Location: $(cnLocation)
        Windows_NetFramework (China):
          OSName: "Windows"
          OSVmImage: "windows-2019"
          TestTargetFramework: net461
          CloudType: cn
          AdditionalParameters: $(cnAdditionalParameters)
          Location: $(cnLocation)

    pool:
      vmImage: $(OSVmImage)

    variables:
      publicAdditionalParameters: "@{ storageEndpointSuffix = 'core.windows.net'; authorityHost = 'https://login.microsoftonline.com'; location = '$(publicLocation)' }"
      publicLocation: westus2
      govAdditionalParameters: "@{ storageEndpointSuffix = 'core.usgovcloudapi.net'; authorityHost = 'https://login.microsoftonline.us/'; location = '$(govLocation)' }"
      govLocation: usgovvirginia
      cnAdditionalParameters: "@{ storageEndpointSuffix = 'core.chinacloudapi.cn'; authorityHost = 'https://login.chinacloudapi.cn'; location = '$(cnLocation)' }"
      cnLocation: chinaeast2

    steps:
      - task: DotNetCoreInstaller@2
        displayName: "Use .NET Core runtime $(DotNetCoreRuntimeVersion)"
        inputs:
          packageType: runtime
          version: "$(DotNetCoreRuntimeVersion)"

      - task: DotNetCoreInstaller@2
        displayName: "Use .NET Core sdk $(DotNetCoreSDKVersion)"
        inputs:
          packageType: sdk
          version: "$(DotNetCoreSDKVersion)"

      - task: PowerShell@2
        inputs:
          targetType: filePath
          filePath: ./common/SmokeTests/SmokeTest/Update-Dependencies.ps1
          arguments: -CI
          workingDirectory: common/SmokeTests/SmokeTest
          pwsh: true
        displayName: Use latest dev feed package versions

      - pwsh: Get-Content ./common/SmokeTests/SmokeTest/SmokeTest.csproj
        displayName: Show SmokeTest.csproj

      - pwsh: dotnet restore ./common/SmokeTests/SmokeTest/SmokeTest.csproj
        displayName: dotnet restore

      - template: common/TestResources/deploy-soverign-resources.yml
        parameters:
          ServiceDirectory: '$(Build.SourcesDirectory)/common/SmokeTests/'
          AdditionalParameters: $(AdditionalParameters)
          Location: $(Location)

      - pwsh: dotnet run -p .\common\SmokeTests\SmokeTest\SmokeTest.csproj --framework $(TestTargetFramework)
        displayName: "Run Smoke Tests"

      - template: common/TestResources/remove-soverign-resources.yml