variables:
  - template: ./templates/variables/globals.yml
  - name: BlobFeedUrl
    value: 'https://azuresdkartifacts.blob.core.windows.net/azure-sdk-for-net/index.json'

jobs:
  - job: SmokeTest

    strategy:
      matrix:
        Linux:
          OSName: "Linux"
          OSVmImage: "ubuntu-16.04"
          TestTargetFramework: netcoreapp2.1
        Windows_NetCoreApp:
          OSName: "Windows"
          OSVmImage: "windows-2019"
          TestTargetFramework: netcoreapp2.1
        Windows_NetFramework:
          OSName: "Windows"
          OSVmImage: "windows-2019"
          TestTargetFramework: net461
        MacOs:
          OSName: "MacOS"
          OSVmImage: "macOS-10.15"
          TestTargetFramework: netcoreapp2.1

    pool:
      vmImage: $(OSVmImage)

    steps:
      - task: DotNetCoreInstaller@2
        displayName: "Use .NET Core runtime $(DotNetCoreRuntimeVersion)"
        inputs:
          packageType: runtime
          version: "$(DotNetCoreRuntimeVersion)"

      - task: DotNetCoreInstaller@2
        displayName: "Use .NET Core sdk $(DotNetCoreSDKVersion)"
        inputs:
          packageType: sdk
          version: "$(DotNetCoreSDKVersion)"

      - pwsh: Register-PackageSource -Name NightlyFeed -Location '$(BlobFeedUrl)' -ProviderName Nuget
        displayName: Register nightly feed package source

      - task: PowerShell@2
        inputs:
          targetType: filePath
          filePath: ./common/SmokeTests/SmokeTest/Update-Dependencies.ps1
          arguments: -Framework $(TestTargetFramework)
          workingDirectory: common/SmokeTests/SmokeTest
          pwsh: true
        displayName: Use latest dev feed package versions

      - task: PowerShell@2
        inputs:
          targetType: filePath
          filePath: ./common/SmokeTests/SmokeTest/Test-DependencyDevVersions.ps1
          workingDirectory: common/SmokeTests/SmokeTest
          pwsh: true
        continueOnError: true
        displayName: Validate Package Versions

      - pwsh: dotnet restore ./common/SmokeTests/SmokeTest/SmokeTest.csproj
        displayName: dotnet restore

      - pwsh: git diff ./common/SmokeTests/SmokeTest/SmokeTest.csproj
        displayName: Show diff of SmokeTest.csproj

      - pwsh: dotnet run -p .\common\SmokeTests\SmokeTest\SmokeTest.csproj --framework $(TestTargetFramework)
        displayName: "Run Smoke Tests"
        env:
          KEY_VAULT_URI: $(smoke-tests-key-vault-project-url)
          EVENT_HUBS_CONNECTION_STRING: $(smoke-tests-event-hubs-connection-string)
          BLOB_CONNECTION_STRING: $(smoke-tests-storage-connection-string)
          CLIENT_SECRET: $(aad-azure-sdk-test-client-secret)
          DIR_TENANT_ID: $(aad-azure-sdk-test-tenant-id)
          APP_CLIENT_ID: $(aad-azure-sdk-test-client-id)
          COSMOS_AUTH_KEY: $(smoke-tests-cosmos-key)
          COSMOS_URI: $(smoke-tests-cosmos-endpoint)
