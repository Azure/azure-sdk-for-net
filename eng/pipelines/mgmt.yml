resources:
  repositories:
    - repository: azure-sdk-build-tools
      type: git
      name: internal/azure-sdk-build-tools
      ref: refs/tags/azure-sdk-build-tools_20230829.1

parameters: 
- name: ShouldPublishToNuget
  type: boolean
  default: false
- name: ShouldPublishToDevOps
  type: boolean
  default: false
- name: Scope
  type: string
  default: ''

trigger: none
pr:
  branches:
    include:
    - main
    - '*-preview'
    - 'feature/cplat*'
  paths:
    include:
    - Directory.Build.props
    - Directory.Build.targets
    - mgmt.proj
    - eng/mgmt.proj
    - eng/pipelines/mgmt.yml
    - eng/pipelines/templates/jobs/ci.mgmt.yml
    - eng/mgmt
    - sdk/mgmtcommon
    - sdk/advisor/Microsoft.Azure.Management.Advisor
    - sdk/alertsmanagement/Microsoft.Azure.Management.AlertsManagement
    - sdk/analysisservices/Microsoft.Azure.Management.AnalysisServices
    - sdk/apimanagement/Microsoft.Azure.Management.ApiManagement
    - sdk/applicationinsights/Microsoft.Azure.Management.ApplicationInsights
    - sdk/appplatform/Microsoft.Azure.Management.AppPlatform
    - sdk/attestation/Microsoft.Azure.Management.Attestation
    - sdk/authorization/Microsoft.Azure.Management.Authorization
    - sdk/automanage/Microsoft.Azure.Management.Automanage
    - sdk/automation/Microsoft.Azure.Management.Automation
    - sdk/avs/Microsoft.Azure.Management.Avs
    - sdk/azurestack/Microsoft.AzureStack.Management.AzureBridge.Admin
    - sdk/azurestack/Microsoft.AzureStack.Management.Backup.Admin
    - sdk/azurestack/Microsoft.AzureStack.Management.Commerce.Admin
    - sdk/azurestack/Microsoft.AzureStack.Management.Compute.Admin
    - sdk/azurestack/Microsoft.AzureStack.Management.Fabric.Admin
    - sdk/azurestack/Microsoft.AzureStack.Management.Gallery.Admin
    - sdk/azurestack/Microsoft.AzureStack.Management.InfrastructureInsights.Admin
    - sdk/azurestack/Microsoft.AzureStack.Management.KeyVault.Admin
    - sdk/azurestack/Microsoft.AzureStack.Management.Network.Admin
    - sdk/azurestack/Microsoft.AzureStack.Management.Storage.Admin
    - sdk/azurestack/Microsoft.AzureStack.Management.Subscription
    - sdk/azurestack/Microsoft.AzureStack.Management.Subscriptions.Admin
    - sdk/azurestack/Microsoft.AzureStack.Management.Update.Admin
    - sdk/azurestackhci/Microsoft.Azure.Management.AzureStackHCI
    - sdk/batch/Microsoft.Azure.Management.Batch
    - sdk/batchai/Microsoft.Azure.Management.BatchAI
    - sdk/billing/Microsoft.Azure.Management.Billing
    - sdk/blueprint/Microsoft.Azure.Management.Blueprint
    - sdk/botservice/Microsoft.Azure.Management.BotService
    - sdk/cdn/Microsoft.Azure.Management.Cdn
    - sdk/changeanalysis/Microsoft.Azure.Management.ChangeAnalysis
    - sdk/chaos/Microsoft.Azure.Management.Chaos
    - sdk/cognitiveservices/Microsoft.Azure.Management.CognitiveServices
    - sdk/compute/Microsoft.Azure.Management.Compute
    - sdk/confluent/Microsoft.Azure.Management.Confluent
    - sdk/consumption/Microsoft.Azure.Management.Consumption
    - sdk/containerinstance/Microsoft.Azure.Management.ContainerInstance
    - sdk/containerregistry/Microsoft.Azure.Management.ContainerRegistry
    - sdk/containerservice/Microsoft.Azure.Management.ContainerService
    - sdk/cosmosdb/Microsoft.Azure.Management.CosmosDB
    - sdk/cost-management/Microsoft.Azure.Management.CostManagement
    - sdk/customer-insights/Microsoft.Azure.Management.CustomerInsights
    - sdk/customproviders/Microsoft.Azure.Management.CustomProviders
    - sdk/databox/Microsoft.Azure.Management.DataBox
    - sdk/databoxedge/Microsoft.Azure.Management.DataBoxEdge
    - sdk/datadog/Microsoft.Azure.Management.Datadog
    - sdk/datafactory/Microsoft.Azure.Management.DataFactory
    - sdk/datalake-analytics/Microsoft.Azure.Management.DataLake.Analytics
    - sdk/datalake-store/Microsoft.Azure.Management.DataLake.Store
    - sdk/datamigration/Microsoft.Azure.Management.DataMigration
    - sdk/dataprotection/Microsoft.Azure.Management.DataProtection
    - sdk/datashare/Microsoft.Azure.Management.DataShare
    - sdk/deploymentmanager/Microsoft.Azure.Management.DeploymentManager
    - sdk/deviceprovisioningservices/Microsoft.Azure.Management.DeviceProvisioningServices
    - sdk/deviceupdate/Microsoft.Azure.Management.DeviceUpdate
    - sdk/devspaces/Microsoft.Azure.Management.DevSpaces
    - sdk/devtestlabs/Microsoft.Azure.Management.DevTestLabs
    - sdk/digitaltwins/Microsoft.Azure.Management.DigitalTwins
    - sdk/dns/Microsoft.Azure.Management.Dns
    - sdk/edgegateway/Microsoft.Azure.Management.EdgeGateway
    - sdk/elastic/Microsoft.Azure.Management.Elastic
    - sdk/eng/mgmt
    - sdk/eventgrid/Microsoft.Azure.Management.EventGrid
    - sdk/eventhub/Microsoft.Azure.Management.EventHub
    - sdk/extendedlocation/Microsoft.Azure.Management.ExtendedLocation
    - sdk/frontdoor/Microsoft.Azure.Management.FrontDoor
    - sdk/guestconfiguration/Microsoft.Azure.Management.GuestConfiguration
    - sdk/hdinsight/Microsoft.Azure.Management.HDInsight
    - sdk/healthbot/Microsoft.Azure.Management.Healthbot
    - sdk/healthcareapis/Microsoft.Azure.Management.HealthcareApis
    - sdk/hybridcompute/Microsoft.Azure.Management.HybridCompute
    - sdk/hybriddatamanager/Microsoft.Azure.Management.HybridDataManager
    - sdk/hybridkubernetes/Microsoft.Azure.Management.Kubernetes
    - sdk/insights/Microsoft.Azure.Management.Insights
    - sdk/iotcentral/Microsoft.Azure.Management.IotCentral
    - sdk/iothub/Microsoft.Azure.Management.IotHub
    - sdk/keyvault/Microsoft.Azure.Management.KeyVault
    - sdk/kubernetesconfiguration/Microsoft.Azure.Management.KubernetesConfiguration
    - sdk/kusto/Microsoft.Azure.Management.Kusto
    - sdk/labservices/Microsoft.Azure.Management.LabServices
    - sdk/locationbasedservices/Microsoft.Azure.Management.LocationBasedServices
    - sdk/logic/Microsoft.Azure.Management.Logic
    - sdk/logz/Microsoft.Azure.Management.Logz
    - sdk/machinelearning/Microsoft.Azure.Management.MachineLearning
    - sdk/machinelearningcompute/Microsoft.Azure.Management.MachineLearningCompute
    - sdk/machinelearningservices/Microsoft.Azure.Management.MachineLearningServices
    - sdk/maintenance/Microsoft.Azure.Management.Maintenance
    - sdk/managednetwork/Microsoft.Azure.Management.ManagedNetwork
    - sdk/managedserviceidentity/Microsoft.Azure.Management.ManagedServiceIdentity
    - sdk/managedservices/Microsoft.Azure.Management.ManagedServices
    - sdk/managementgroups/Microsoft.Azure.Management.ManagementGroups
    - sdk/managementpartner/Microsoft.Azure.Management.ManagementPartner
    - sdk/maps/Microsoft.Azure.Management.Maps
    - sdk/marketplace/Microsoft.Azure.Management.Marketplace
    - sdk/marketplaceordering/Microsoft.Azure.Management.MarketplaceOrdering
    - sdk/mediaservices/Microsoft.Azure.Management.Media
    - sdk/mgmtcommon/AppAuthentication
    - sdk/mgmtcommon/Auth
    - sdk/mgmtcommon/ClientRuntime
    - sdk/mgmtcommon/ClientRuntime.Azure
    - sdk/mgmtcommon/ClientRuntime.Etw
    - sdk/mgmtcommon/ClientRuntime.Log4Net
    - sdk/mgmtcommon/Test
    - sdk/mgmtcommon/TestFramework
    - sdk/mixedreality/Microsoft.Azure.Management.MixedReality
    - sdk/monitor/Microsoft.Azure.Management.Monitor
    - sdk/mysql/Microsoft.Azure.Management.MySQL
    - sdk/netapp/Microsoft.Azure.Management.NetApp
    - sdk/network/Microsoft.Azure.Management.Network
    - sdk/notificationhubs/Microsoft.Azure.Management.NotificationHubs
    - sdk/operationalinsights/Microsoft.Azure.Management.OperationalInsights
    - sdk/peering/Microsoft.Azure.Management.Peering
    - sdk/policyinsights/Microsoft.Azure.Management.PolicyInsights
    - sdk/postgresql/Microsoft.Azure.Management.PostgreSQL
    - sdk/powerbidedicated/Microsoft.Azure.Management.PowerBIDedicated
    - sdk/privatedns/Microsoft.Azure.Management.PrivateDns
    - sdk/providerhub/Microsoft.Azure.Management.ProviderHub
    - sdk/purview/Microsoft.Azure.Management.Purview
    - sdk/quantum/Microsoft.Azure.Management.Quantum
    - sdk/quota/Microsoft.Azure.Management.Quota
    - sdk/recoveryservices/Microsoft.Azure.Management.RecoveryServices
    - sdk/recoveryservices-backup/Microsoft.Azure.Management.RecoveryServices.Backup
    - sdk/recoveryservices-siterecovery/Microsoft.Azure.Management.RecoveryServices.SiteRecovery
    - sdk/redis/Microsoft.Azure.Management.RedisCache
    - sdk/redisenterprise/Microsoft.Azure.Management.RedisEnterpriseCache
    - sdk/relay/Microsoft.Azure.Management.Relay
    - sdk/reservations/Microsoft.Azure.Management.Reservations
    - sdk/resourcegraph/Microsoft.Azure.Management.ResourceGraph
    - sdk/resourcemover/Microsoft.Azure.Management.Migrate
    - sdk/resources/Microsoft.Azure.Management.Resource
    - sdk/scheduler/Microsoft.Azure.Management.Scheduler
    - sdk/search/Microsoft.Azure.Management.Search
    - sdk/securitycenter/Microsoft.Azure.Management.SecurityCenter
    - sdk/securityinsights/Microsoft.Azure.Management.SecurityInsights
    - sdk/servermanagement/Microsoft.Azure.Management.ServerManagement
    - sdk/servicebus/Microsoft.Azure.Management.ServiceBus
    - sdk/servicefabric/Microsoft.Azure.Management.ServiceFabric
    - sdk/servicefabricmanagedclusters/Microsoft.Azure.Management.ServiceFabricManagedClusters
    - sdk/signalr/Microsoft.Azure.Management.SignalR
    - sdk/sqlmanagement/Microsoft.Azure.Management.Sql
    - sdk/sqlvirtualmachine/Microsoft.Azure.Management.SqlVirtualMachine
    - sdk/storage/Microsoft.Azure.Management.Storage
    - sdk/storagecache/Microsoft.Azure.Management.StorageCache
    - sdk/storagesync/Microsoft.Azure.Management.StorageSync
    - sdk/storsimple/Microsoft.Azure.Management.StorSimple
    - sdk/storsimple8000series/Microsoft.Azure.Management.StorSimple8000Series
    - sdk/streamanalytics/Microsoft.Azure.Management.StreamAnalytics
    - sdk/subscription/Microsoft.Azure.Management.Subscription
    - sdk/support/Microsoft.Azure.Management.Support
    - sdk/synapse/Microsoft.Azure.Management.Synapse
    - sdk/trafficmanager/Microsoft.Azure.Management.TrafficManager
    - sdk/websites/Microsoft.Azure.Management.WebSites
    - sdk/workloadmonitor/Microsoft.Azure.Management.WorkloadMonitor
variables:
- template: templates/variables/globals.yml
- name: msBuildLogDir
  value: msbuildlogs
- name: loggingArgs
  value: /clp:ShowtimeStamp /flp:Summary;Verbosity=minimal;LogFile=$(msBuildLogDir)/msbuild.sum.log /flp1:warningsonly;logfile=$(msBuildLogDir)/msbuild.wrn.log /flp2:errorsonly;logfile=$(msBuildLogDir)/msbuild.err.log
- name: RPScopeArgs
  value: /p:PullRequestNumber=$(system.pullrequest.pullrequestnumber) /p:RepoHtmlUrl=https://github.com/$(build.repository.id) /p:CIBuildId=$(OfficialBuildId)
- name: timeoutInMinutes
  value: 120

stages:
  - stage: Build
    jobs:
      - template: /eng/pipelines/templates/jobs/ci.mgmt.yml
        parameters:
          Scope: ${{ parameters.Scope }}
          ${{ if or(eq(parameters.ShouldPublishToNuget, 'true'), eq(parameters.ShouldPublishToDevOps, 'true')) }}:
            ShouldPublish: true

      - ${{ if and(ne(variables['Build.Reason'], 'PullRequest'), eq(variables['System.TeamProject'], 'internal')) }}:
        - template: /eng/pipelines/templates/jobs/mgmt-release.yml
          parameters:
            DependsOn: Build
            ShouldPublishToNuget: ${{ parameters.ShouldPublishToNuget }}
            ShouldPublishToDevOps: ${{ parameters.ShouldPublishToDevOps }}