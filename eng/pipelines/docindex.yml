jobs:
  - job: GenerateDocIndex
    variables:
      - template: templates/variables/globals.yml
    pool:
      vmImage: windows-2019
    steps:
      - task: UsePythonVersion@0
        displayName: 'Use Python 3.6'
        inputs:
          versionSpec: '3.6'
      - pwsh: |
          Invoke-WebRequest -MaximumRetryCount 10 -Uri "https://github.com/dotnet/docfx/releases/download/$(DocFxVersion)/docfx.zip" `
          -OutFile "docfx.zip" | Wait-Process; Expand-Archive -Path "docfx.zip" -DestinationPath "./docfx/"
          echo "##vso[task.setvariable variable=docfxPath;isOutput=true]$(Build.SourcesDirectory)/docfx/docfx.exe"
        workingDirectory: $(Build.SourcesDirectory)
        displayName: Download and Extract DocFX
        name: setupDocfxTool
      - task: PowerShell@2
        displayName: 'Generate Doc Index'
        inputs:
          pwsh: true
          filePath: $(Build.SourcesDirectory)/doc/ApiDocGeneration/Generate-DocIndex.ps1
          arguments: >
            -Docfx $(setupDocfxTool.docfxPath)
            -RepoRoot $(Build.SourcesDirectory)
            -DocGenDir "$(Build.SourcesDirectory)/doc/ApiDocGeneration"
            -verbose
      - task: UsePythonVersion@0
        displayName: 'Use Python 3.6'
        inputs:
          versionSpec: '3.6'
      - template: /eng/common/pipelines/templates/steps/mashup-doc-index.yml
        parameters:
          SourceDirectory: $(Build.SourcesDirectory)
      - task: CopyFiles@2
        displayName: Copy HTML to Artifacts Directory
        inputs:
          sourceFolder: $(Build.SourcesDirectory)/docfx_project/
          content: '**\*'
          targetFolder: $(Build.ArtifactStagingDirectory)/docfx_project
          overWrite: true
      - task: PublishPipelineArtifact@0
        condition: succeeded()
        inputs:
          artifactName: "Doc.Index"
          targetPath: $(Build.ArtifactStagingDirectory)/docfx_project/_site