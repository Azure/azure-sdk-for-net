parameters:
  ServiceDirectory: ''
  Artifacts: ''
  PackageInfoFolder: ''

steps:

- ${{ if eq(parameters.ServiceDirectory, 'auto') }}:
  - pwsh:
      $packageInfos = Get-ChildItem -Path "${{ parameters.PackageInfoFolder }}" -Filter "*.json" -File `
        | ForEach-Object { Get-Content -Raw $_.FullName | ConvertFrom-Json }

      Write-Host "Found $($packageInfos.Count) package(s) to check for AOT compatibility."
      
      $failedAotChecks = $false
      foreach ($package in $packageInfos) {
        $packagePath = "$($package.DirectoryPath)/src/$($package.ArtifactName).csproj"
        
        Write-Host "Running Check-AOT-Compatibility.ps1 for Package: $($package.ArtifactName)"
        Write-Host "Package Path: $packagePath"
        Write-Host "$(Build.SourcesDirectory)\eng\scripts\compatibility\Check-AOT-Compatibility.ps1"
        
        & "$(Build.SourcesDirectory)\eng\scripts\compatibility\Check-AOT-Compatibility.ps1" -PackagePath "$packagePath"
        
        if ($LASTEXITCODE -ne 0) {
          $failedAotChecks = $true
        }
      }
      
      if ($failedAotChecks) {
        Write-Error "AOT compatibility check failed for one or more packages."
        exit 1
      }
    workingDirectory: $(Build.SourcesDirectory)/eng/scripts/compatibility
- ${{ else }}:
  - ${{ each artifact in parameters.Artifacts }}:
    - task: Powershell@2
      displayName: Check for AOT compatibility regressions in ${{ artifact.name }}
      inputs:
        targetType: filepath
        filePath: $(Build.SourcesDirectory)/eng/scripts/compatibility/Check-AOT-Compatibility.ps1
        arguments: >-
          -ServiceDirectory ${{ parameters.ServiceDirectory }}
          -PackageName ${{ artifact.name }}
          -DirectoryName ${{ artifact.directoryName }}
        workingDirectory: $(Build.SourcesDirectory)/eng/scripts/compatibility
