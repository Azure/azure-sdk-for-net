parameters:
  ServiceDirectory: 'not-specified'
  Artifacts: []
  ArtifactsDirectory: 'not-specified'

steps:
  - pwsh: |
      $artifactNames = @()
      $artifactsDir = '${{ parameters.ArtifactsDirectory }}'
      $enVars = [Environment]::GetEnvironmentVariables()
      $artifactNames = $enVars.GetEnumerator() | Where-Object { $_.Key -like 'KGXZY_*' }
      $artifactsDirContent = Get-ChildItem -Path $artifactsDir

      foreach ($artifact in $artifactNames)
      {
        $artifactName = $artifact.Value
        Write-Host "Create Directory "$artifactName
        New-Item -Path $artifactsDir -Name $artifactName -ItemType directory

        $artifactNameRegex = [regex]::escape($artifactName) + '\.((([0-9]+\.[0-9]+\.[0-9]+.*.nupkg)|docs.zip?))'
        $correspondingArtifacts = $artifactsDirContent | Where-Object { $_.Name -match $artifactNameRegex }

        $dest = Join-Path $artifactsDir $artifactName
        foreach ($artifact in $correspondingArtifacts)
        {
          if (Test-Path $artifact.FullName)
          {
            Write-Host "Moving " $artifact.Name
            Move-Item -Path $artifact.FullName -Destination $dest -Force
          }
        }
      }
    displayName: Arrange Artifacts
    env:
      ${{ each artifact in parameters.Artifacts }}:
        ${{ format('KGXZY_{0}', artifact.safeName) }}: ${{ artifact.name }}