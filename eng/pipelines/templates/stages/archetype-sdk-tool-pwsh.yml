parameters:
  - name: TargetDirectory
    type: string
  - name: CustomTestSteps
    type: object
    default: []
  - name: EnvVars
    type: object
    default: {}
  - name: TargetTags
    type: string
    default: ''

variables:
  - template: /eng/pipelines/templates/variables/globals.yml
  - template: /eng/pipelines/templates/variables/image.yml

stages:
  - stage: 'Test'
    jobs:
      - job: 'Test'

        strategy:
          matrix:
            Windows:
              Pool: '$(WINDOWSPOOL)'
              ImageDemand: '$(WindowsImageDemand)'
            Linux:
              Pool: '$(LINUXPOOL)'
              ImageDemand: '$(LinuxImageDemand)'
            Mac:
              Pool: '$(MACPOOL)'
              ImageVm: '$(MACVMIMAGE)'

        pool:
          name: $(Pool)
          ${{ if eq(variables['Pool'], variables['MACPOOL']) }}:
            vmImage: $(ImageVm)
          ${{ else }}:
            demands: $(ImageDemand)

        steps:
          - template: /eng/pipelines/templates/steps/run-pester-tests.yml
            parameters:
              TargetDirectory: ${{ parameters.TargetDirectory }}
              CustomTestSteps: ${{ parameters.CustomTestSteps }}
              EnvVars: ${{ parameters.EnvVars }}
              TargetTags: ${{ parameters.TargetTags }}
